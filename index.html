<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen-Forca</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Base & Typography --- */
        :root {
            --color-primary: #007bff; /* Blue */
            --color-secondary: #28a745; /* Green */
            --color-warning: #ffc107; /* Yellow */
            --color-danger: #dc3545; /* Red */
            --color-background: #f4f6f9;
            --color-card: #ffffff;
            --color-text-dark: #212529;
            --color-text-light: #6c757d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #app-container {
            width: 100%;
            max-width: 1000px;
            background-color: var(--color-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        /* --- Headers --- */
        h1 {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--color-text-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 span.symbol {
            font-size: 2.5rem;
            color: var(--color-secondary);
            margin-right: 10px;
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-primary);
            display: flex;
            align-items: center;
        }

        /* --- Buttons --- */
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            border: none;
            flex: 1;
            margin: 0 5px;
        }

        .btn-deposit {
            background-color: var(--color-secondary);
            color: white;
        }

        .btn-deposit:hover:not(:disabled) {
            background-color: #218838;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
        }

        .btn-withdraw {
            background-color: var(--color-danger);
            color: white;
        }

        .btn-withdraw:hover:not(:disabled) {
            background-color: #c82333;
            box-shadow: 0 4px 6px rgba(220, 53, 69, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- Form Elements --- */
        .input-group {
            margin-bottom: 15px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .input-field:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 5px;
        }

        /* --- Account Details & Balance --- */
        #user-account-details {
            background-color: #e9f5ff; /* Light Blue */
            border-left: 5px solid var(--color-primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .balance-display {
            font-size: 2.5rem;
            font-weight: 800;
            margin-top: 10px;
            display: block;
        }

        .balance-label {
            font-size: 1rem;
            color: var(--color-text-light);
            font-weight: 600;
        }

        .text-bvn {
            color: var(--color-secondary);
        }
        
        .text-ngn {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-dark);
            margin-top: 5px;
            display: block;
        }

        .text-negative {
            color: var(--color-danger);
        }

        .text-positive {
            color: var(--color-secondary);
        }

        /* --- Admin View Specifics --- */
        #admin-view h2 {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        #admin-account-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 15px; /* Space for scrollbar */
            margin-top: 15px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: var(--color-card);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
        }

        .account-item.admin-self {
            border: 2px solid var(--color-warning);
            background-color: #fffde7;
        }

        .account-details p {
            margin: 0;
        }

        .account-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-text-dark);
        }

        .account-uid {
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--color-text-light);
            word-break: break-all;
        }
        
        .account-balance-display {
            text-align: right;
        }

        .account-balance-display .bvn {
            font-size: 1.5rem;
            font-weight: 800;
        }

        /* --- Messages & Loading --- */
        .message-box {
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .msg-error {
            background-color: #f8d7da;
            color: var(--color-danger);
            border: 1px solid #f5c6cb;
        }

        .msg-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #loading-state {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 123, 255, 0.1);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            #app-container {
                padding: 15px;
            }
            h1 {
                font-size: 1.75rem;
            }
            .balance-display {
                font-size: 2rem;
            }
            .btn-container {
                flex-direction: column;
            }
            .btn {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1>
                <span class="symbol">₿</span>
                BitVen-Forca
                <span style="font-size: 1rem; font-weight: 400; color: var(--color-secondary); margin-left: 10px;">(1 BVN = ₦1,000)</span>
            </h1>
            <p id="auth-status" style="font-size: 0.9rem; font-weight: 600; margin-top: 5px; color: var(--color-text-light);">Initializing...</p>
        </header>

        <!-- Loading State -->
        <div id="loading-state">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: var(--color-text-light);">Connecting to the Ledger...</p>
        </div>

        <!-- Admin View Container -->
        <div id="admin-view" style="display: none;">
            <h2>Admin Dashboard</h2>
            <p style="font-size: 0.9rem; color: var(--color-text-light);">Viewing all accounts. Wallet Owner: <span id="admin-user-id" style="font-family: monospace;"></span></p>
            <div id="admin-account-list">
                <!-- Accounts will be injected here -->
            </div>
            <div id="admin-empty-state" class="message-box" style="display: none;">
                No accounts found in the database. Please check seeding function.
            </div>
        </div>

        <!-- User View Container -->
        <div id="user-view" style="display: none;">
            <h2>Your Account</h2>
            <div id="user-account-details">
                <p style="font-size: 1.1rem; font-weight: 600;">Welcome, <span id="user-account-name" style="color: var(--color-primary);"></span>!</p>
                <p style="font-size: 0.8rem; color: var(--color-text-light); margin-top: 5px;">User ID: <span id="user-id" style="font-family: monospace;"></span></p>
                
                <hr style="margin: 15px 0; border-color: #cce5ff;">

                <div class="balance-label">Current Balance</div>
                <span id="account-balance-bvn" class="balance-display text-bvn">0.00 BVN</span>
                <span id="account-balance-ngn" class="text-ngn">₦0.00</span>
            </div>

            <!-- Transaction Form -->
            <div style="background-color: var(--color-card); padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--color-text-dark); margin-bottom: 20px;">Secure Transaction</h3>
                <div class="input-group">
                    <label for="transaction-amount" class="label">Amount (BVN)</label>
                    <input type="number" id="transaction-amount" class="input-field" placeholder="e.g., 50.50" min="0.01" step="0.01">
                </div>
                
                <div id="error-message" class="message-box msg-error" style="display: none;"></div>
                
                <div class="btn-container" style="display: flex; margin-top: 20px;">
                    <button id="deposit-btn" class="btn btn-deposit">Deposit BVN</button>
                    <button id="withdraw-btn" class="btn btn-withdraw">Withdraw BVN</button>
                </div>
                
                <div id="transaction-feedback" class="message-box msg-success" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Script Block -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, runTransaction, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Globals ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const ADMIN_EMAIL = 'lanushomeappliances@gmail.com';
        const BVN_TO_NGN_RATE = 1000; // 1 BVN = ₦1,000

        let app, db, auth, userId = null;
        let isAdmin = false;

        // --- DOM Elements (Cached) ---
        const loadingStateEl = document.getElementById('loading-state');
        const authStatusEl = document.getElementById('auth-status');
        const userViewEl = document.getElementById('user-view');
        const adminViewEl = document.getElementById('admin-view');
        const accountBalanceBvnEl = document.getElementById('account-balance-bvn');
        const accountBalanceNgnEl = document.getElementById('account-balance-ngn');
        const transactionAmountEl = document.getElementById('transaction-amount');
        const depositBtn = document.getElementById('deposit-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const errorMessageEl = document.getElementById('error-message');
        const transactionFeedbackEl = document.getElementById('transaction-feedback');
        const adminAccountListEl = document.getElementById('admin-account-list');
        const adminEmptyStateEl = document.getElementById('admin-empty-state');
        
        // --- Utility Functions ---

        const formatBVN = (amount) => {
            return `${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} BVN`;
        };
        
        const formatNaira = (amount) => {
            const ngnValue = parseFloat(amount) * BVN_TO_NGN_RATE;
            // Use en-NG locale for Naira symbol and thousand separators
            return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(ngnValue);
        };

        const displayMessage = (el, text, type = 'success', duration = 5000) => {
            el.textContent = text;
            el.className = `message-box msg-${type}`;
            el.style.display = 'block';

            setTimeout(() => {
                el.style.display = 'none';
            }, duration);
        };

        const setLoading = (isLoading) => {
            depositBtn.disabled = isLoading;
            withdrawBtn.disabled = isLoading;
            if (isLoading) {
                 transactionFeedbackEl.style.display = 'block';
                 transactionFeedbackEl.textContent = 'Processing transaction securely...';
                 transactionFeedbackEl.className = 'message-box msg-success';
                 errorMessageEl.style.display = 'none';
            } else {
                 // The success/error message display handles its own visibility
            }
        };

        // --- Database & Seeding ---
        const getAccountCollectionRef = () => {
             // Mandatory Public Data Path
             return collection(db, 'artifacts', appId, 'public', 'data', 'accounts');
        };

        async function seedDatabase(currentUserId, currentUserEmail) {
            const accountsRef = getAccountCollectionRef();
            // We only check for the admin account doc existence to decide if seeding is needed
            const adminDocRef = doc(accountsRef, currentUserId);
            
            try {
                const adminDoc = await getDocs(accountsRef);
                
                if (adminDoc.empty) {
                    console.log("Database empty. Seeding with initial accounts.");
                    
                    const seedAccounts = [
                        { 
                            name: "Admin Master Wallet", 
                            email: ADMIN_EMAIL, 
                            balance: 100000.00, // Large starting balance
                            userId: currentUserId // This is the admin's actual UID
                        },
                        { 
                            name: "Test User Alpha", 
                            email: "test.alpha@bitven.com", 
                            balance: 5000.00, 
                            userId: 'test_uid_alpha'
                        },
                        { 
                            name: "Test User Beta", 
                            email: "test.beta@bitven.com", 
                            balance: 1000.75, 
                            userId: 'test_uid_beta'
                        }
                    ];

                    for (const account of seedAccounts) {
                        // Use the userId as the document ID
                        await setDoc(doc(accountsRef, account.userId), account);
                    }
                    console.log("Database seeded successfully.");
                } else if (currentUserEmail === ADMIN_EMAIL) {
                    // If the user is admin, ensure their profile exists and is updated
                    await setDoc(adminDocRef, {
                        name: "Admin Master Wallet",
                        email: ADMIN_EMAIL,
                        userId: currentUserId 
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Seeding or Admin Doc Update Failed:", error);
            }
        }

        // --- View Logic ---
        
        function setupAdminView(currentUserId) {
            userViewEl.style.display = 'none';
            adminViewEl.style.display = 'block';

            document.getElementById('admin-user-id').textContent = currentUserId;

            // Listen for all accounts in real-time
            const accountsRef = getAccountCollectionRef();
            onSnapshot(accountsRef, (snapshot) => {
                const accountsData = [];
                snapshot.forEach(doc => {
                    accountsData.push({ id: doc.id, ...doc.data() });
                });
                renderAdminAccounts(accountsData);
            }, (error) => {
                console.error("Admin Snapshot Error:", error);
                adminAccountListEl.innerHTML = `<p style="color: var(--color-danger);">Error loading accounts: ${error.message}</p>`;
            });
        }

        function renderAdminAccounts(accounts) {
            adminAccountListEl.innerHTML = '';
            
            if (accounts.length === 0) {
                adminEmptyStateEl.style.display = 'block';
                return;
            }
            adminEmptyStateEl.style.display = 'none';

            // Sort by BVN balance descending
            accounts.sort((a, b) => b.balance - a.balance); 

            accounts.forEach(account => {
                const isCurrentUser = account.userId === userId;
                const balanceClass = account.balance < 0 ? 'text-negative' : 'text-positive';
                const balanceDisplay = formatBVN(account.balance);
                const ngnDisplay = formatNaira(account.balance);

                const accountEl = document.createElement('div');
                accountEl.className = `account-item ${isCurrentUser ? 'admin-self' : ''}`;
                
                accountEl.innerHTML = `
                    <div class="account-details">
                        <p class="account-name">${account.name} ${isCurrentUser ? '(YOU / ADMIN)' : ''}</p>
                        <p class="account-uid">UID: ${account.userId}</p>
                        <p style="font-size: 0.85rem; color: var(--color-text-light); margin-top: 2px;">${account.email}</p>
                    </div>
                    <div class="account-balance-display">
                        <p class="bvn ${balanceClass}">${balanceDisplay}</p>
                        <p style="font-size: 0.8rem; color: var(--color-text-light);">${ngnDisplay}</p>
                    </div>
                `;
                adminAccountListEl.appendChild(accountEl);
            });
        }

        // --- User View Logic ---

        let userAccountId = null; 

        async function setupUserView(currentUserId, currentUserEmail) {
            adminViewEl.style.display = 'none';
            userViewEl.style.display = 'block';

            userAccountId = currentUserId;
            
            document.getElementById('user-id').textContent = userAccountId;

            // Admin is seeded with a balance in seedDatabase. Non-admin users need a doc too.
            if (!isAdmin) {
                 const accountsRef = getAccountCollectionRef();
                 await setDoc(doc(accountsRef, userAccountId), {
                    name: `BVN User ${currentUserId.substring(0, 4)}`,
                    email: currentUserEmail || 'Anonymous User',
                    balance: 0.00,
                    userId: currentUserId
                 }, { merge: true });
            }

            // Set up real-time listener for the user's specific account
            const accountDocRef = doc(getAccountCollectionRef(), userAccountId);
            
            onSnapshot(accountDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    document.getElementById('user-account-name').textContent = data.name;
                    
                    const balance = data.balance || 0.00;
                    const balanceClass = balance < 0 ? 'text-negative' : 'text-positive';
                    
                    accountBalanceBvnEl.textContent = formatBVN(balance);
                    accountBalanceBvnEl.className = `balance-display text-bvn ${balanceClass}`;
                    
                    accountBalanceNgnEl.textContent = formatNaira(balance);
                    accountBalanceNgnEl.className = `text-ngn ${balanceClass}`;
                } else {
                    console.error("User account document not found. Account ID:", userAccountId);
                    accountBalanceBvnEl.textContent = "Account Not Found";
                    accountBalanceBvnEl.className = 'balance-display text-bvn text-negative';
                    accountBalanceNgnEl.textContent = "₦0.00";
                    accountBalanceNgnEl.className = 'text-ngn text-negative';
                }
            }, (error) => {
                console.error("User Snapshot Error:", error);
                displayMessage(errorMessageEl, `Live balance error: ${error.message}`, 'error');
            });

            // Set up event listeners for transactions
            depositBtn.addEventListener('click', () => handleTransaction('deposit'));
            withdrawBtn.addEventListener('click', () => handleTransaction('withdraw'));
        }

        // --- Transaction Logic (Atomic) ---
        
        async function handleTransaction(type) {
            const amount = parseFloat(transactionAmountEl.value);
            
            errorMessageEl.style.display = 'none';
            transactionFeedbackEl.style.display = 'none';
            
            if (isNaN(amount) || amount <= 0) {
                displayMessage(errorMessageEl, 'Please enter a valid amount greater than 0.00 BVN.', 'error');
                return;
            }

            setLoading(true);

            const accountsRef = getAccountCollectionRef();
            const accountDocRef = doc(accountsRef, userAccountId);
            
            try {
                // RUN TRANSACTION: Guarantees atomicity and prevents race conditions
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(accountDocRef);

                    if (!docSnapshot.exists()) {
                        throw new Error("Account does not exist!");
                    }

                    const currentBalance = docSnapshot.data().balance || 0;
                    let newBalance;

                    if (type === 'deposit') {
                        newBalance = currentBalance + amount;
                    } else if (type === 'withdraw') {
                        newBalance = currentBalance - amount;

                        // CRITICAL CHECK: Firestore transaction ensures this is the absolute latest balance
                        if (newBalance < 0) {
                            throw new Error(`Insufficient Funds: Attempted to withdraw ${formatBVN(amount)}, but account balance is only ${formatBVN(currentBalance)}.`);
                        }
                    }

                    // Perform the update within the transaction
                    transaction.update(accountDocRef, { balance: parseFloat(newBalance.toFixed(2)) });
                });

                transactionAmountEl.value = ''; // Clear input on success
                setLoading(false);
                const actionText = type === 'deposit' ? 'Deposited' : 'Withdrew';
                displayMessage(transactionFeedbackEl, `${actionText} ${formatBVN(amount)} successfully! New balance will update shortly.`, 'success');
            
            } catch (error) {
                console.error("Transaction failed:", error);

                let displayMessageText = "Transaction failed. Please try again.";
                
                if (error.message.includes("Insufficient Funds")) {
                    displayMessageText = error.message; // Use the specific error message
                } else if (error instanceof Error) {
                    displayMessageText = `Transaction error: ${error.message}`;
                } else {
                    displayMessageText = error;
                }
                
                setLoading(false);
                displayMessage(errorMessageEl, displayMessageText, 'error');
            }
        }


        // --- Initialization Function ---
        async function initializeBitVen() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authenticate User
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    loadingStateEl.style.display = 'none';
                    if (user) {
                        userId = user.uid;
                        const userEmail = user.email || '';
                        
                        isAdmin = userEmail === ADMIN_EMAIL;
                        
                        // Seed database before setting up views
                        await seedDatabase(userId, userEmail);

                        authStatusEl.textContent = isAdmin 
                            ? `Signed in as ADMIN: ${userEmail}` 
                            : `Signed in as BVN User.`;
                        authStatusEl.style.color = isAdmin ? '#28a745' : '#007bff';

                        if (isAdmin) {
                            setupAdminView(userId);
                        } else {
                            setupUserView(userId, userEmail);
                        }
                    } else {
                        authStatusEl.textContent = 'Authentication required.';
                        authStatusEl.style.color = '#dc3545';
                        userViewEl.style.display = 'none';
                        adminViewEl.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                loadingStateEl.style.display = 'none';
                authStatusEl.textContent = `CRITICAL ERROR: ${error.message}`;
                authStatusEl.style.color = '#dc3545';
            }
        }

        window.onload = initializeBitVen;
    </script>
</body>
</html>

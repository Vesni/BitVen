<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen-Forca</title>
    <!-- Include crypto-js for SHA256 Hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* ================================================== */
        /* CLEAN, BRIGHT CSS THEME (Non-Tailwind)             */
        /* ================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        :root {
            --color-primary: #1d4ed8; 
            --color-secondary: #059669;
            --color-background: #ffffff;
            --color-surface: #f3f4f6;
            --color-text-dark: #111827;
            --color-text-subtle: #6b7280;
            --color-border: #d1d5db;
            --color-shadow: rgba(0, 0, 0, 0.05);
            --color-burn: #ef4444; /* Red */
            --color-reward: #10b981; /* Green */
            --color-admin: #f59e0b; /* Amber */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: auto;
            background: var(--color-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 15px var(--color-shadow);
        }

        h1 {
            color: var(--color-primary);
            font-size: 2.25rem;
            margin-bottom: 20px;
            text-align: center;
        }

        h2 {
            font-size: 1.5rem;
            color: var(--color-text-dark);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .grid-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(1, 1fr);
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .grid-container {
                grid-template-columns: 1.5fr 1fr 1.5fr;
            }
        }
        
        .section {
            padding: 20px;
            background-color: var(--color-surface);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        
        /* Full width for history and chain on large screens */
        .section-full {
            grid-column: 1 / -1;
        }

        /* --- Inputs and Buttons --- */
        input[type="text"], input[type="number"] {
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-weight: 600;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        button:hover:not(:disabled) { background-color: #1e40af; transform: translateY(-1px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* --- Specific Elements --- */
        .balance-info { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--color-secondary);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .balance-admin { color: var(--color-admin); }

        code {
            font-family: monospace;
            background-color: var(--color-border);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.85rem;
            word-break: break-all;
            display: inline-block;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: var(--color-primary);
            font-size: 1.2rem;
            padding: 0;
            margin-left: 5px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .copy-btn:hover { color: #1e40af; }


        /* --- Block Explorer and History --- */
        #chain-output, #history-output, #directory-list { 
            max-height: 400px; 
            overflow-y: auto; 
            background: var(--color-background);
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 10px;
        }
        
        .block-card, .tx-history-item, .directory-item {
            background: white; 
            padding: 15px; 
            border: 1px solid var(--color-border); 
            border-radius: 6px; 
            margin-bottom: 10px; 
            word-wrap: break-word;
        }

        .block-header { font-weight: 700; color: var(--color-text-dark); margin-bottom: 5px; }

        .tx-list details { margin-top: 10px; }
        .tx-list summary { font-weight: 600; cursor: pointer; color: var(--color-primary); }
        .tx-list ul { list-style: none; padding-left: 10px; font-size: 0.85rem; }
        .tx-list li { margin-top: 5px; padding-left: 10px; border-left: 2px solid var(--color-border); }

        .tx-type-burn { color: var(--color-burn); font-weight: 600; }
        .tx-type-reward { color: var(--color-reward); font-weight: 600; }
        .tx-type-request { color: #f97316; font-weight: 600; } /* Orange */

        .status-message { 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 10px; 
            font-weight: 600;
            border: 1px solid;
        }
        .status-success { background-color: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
        .status-error { background-color: #fef2f2; color: #991b1b; border-color: #fca5a5; }

        /* Icon styling for copy button */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            fill: currentColor;
        }
        
        /* Custom form grid for transaction/request */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        @media (min-width: 600px) {
            .form-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        .form-grid input { margin-bottom: 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>üí∞ The BitVen Ledger</h1>
    
    <div class="grid-container">

        <!-- Wallet & Auth (Top Left) -->
        <div class="section" style="grid-column: 1 / 3;">
            <h2>üë§ Wallet & Authentication</h2>
            <div id="auth-status-container">
                <p><strong>Status:</strong> <span id="auth-status">Initializing...</span></p>
                <p style="font-size: 0.8rem; color: var(--color-text-subtle);"><strong>App ID:</strong> <code id="app-id">N/A</code></p>
                <p><strong>Your Wallet ID (UID):</strong> 
                    <code id="wallet-id">N/A</code>
                    <button class="copy-btn" onclick="window.copyWalletId()" title="Copy ID">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7 17a2 2 0 01-2-2V5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H7zM7 5v10h8V5H7zM5 5V3h2V1H5a2 2 0 00-2 2v2h2zM15 15v2h2v-2h-2zM3 15v2H1v-2h2z"/></svg>
                    </button>
                </p>
            </div>
            
            <div class="balance-info">
                <span>Current Balance:</span>
                <span id="current-balance">0 BVN</span>
            </div>
            
            <div class="btn-group">
                <button id="sign-in-btn" onclick="window.signInWithGoogle()" disabled>Sign In / Switch Account</button>
                <button id="sign-out-btn" onclick="window.signOutUser()" disabled>Sign Out</button>
                <button onclick="window.calculateAndDisplayBalance()">Refresh Balance</button>
            </div>
            <div id="tx-status" class="status-message" style="display:none;"></div>
        </div>
        
        <!-- Mining Pool (Top Right) -->
        <div class="section">
            <h2>‚õèÔ∏è Mining Pool</h2>
            <p>Pending Transactions: <span id="pending-tx-count">0</span></p>
            <p>Difficulty: <span id="difficulty-display">5</span> (Target leading zeros)</p>
            <button id="mine-btn" onclick="window.mineBlock()" disabled>Start Mining Block</button>
            <div id="mine-status" class="status-message" style="display:none;"></div>
        </div>

        <!-- Transaction / Request (Middle Left) -->
        <div class="section" id="transaction-section">
            <h2 id="tx-header">üí∏ Send BitVen</h2>
            <form id="tx-form">
                <input type="text" id="recipient-id" placeholder="Recipient Wallet ID (UID)" required>
                <div class="form-grid">
                    <input type="number" id="amount" placeholder="Amount (BVN)" value="1" step="0.01" min="0.01" required>
                    <input type="text" id="message" placeholder="Message (e.g., for rent)" maxlength="50" style="grid-column: 1 / -1;">
                </div>
                <button id="submit-tx-btn" type="submit" disabled>Submit Payment</button>
            </form>
            <button id="toggle-request-mode-btn" onclick="window.toggleRequestMode()">Switch to Invoice Request</button>
        </div>

        <!-- User Directory (Middle Center) -->
        <div class="section">
            <h2>üë• User Directory</h2>
            <div id="directory-list">Loading users...</div>
        </div>

        <!-- Pending Invoices (Middle Right) -->
        <div class="section">
            <h2>üßæ Pending Invoices Sent To Me</h2>
            <p>These are requests for payment sent to your Wallet ID.</p>
            <div id="invoices-output">No pending invoices.</div>
        </div>

        <!-- Blockchain Display (Bottom Full Width) -->
        <div class="section section-full">
            <h2>üîó Blockchain Ledger</h2>
            <p>Total Blocks: <span id="chain-length">0</span> | Chain Valid: <span id="chain-valid">Checking...</span></p>
            <div id="chain-output">Loading blocks...</div>
        </div>

        <!-- History Display (Bottom Full Width) -->
        <div class="section section-full">
            <h2>‚è±Ô∏è My Transaction History</h2>
            <div id="history-output">Loading history...</div>
        </div>
        
        <!-- Debug Log Output -->
        <div class="section section-full">
            <h2>üñ•Ô∏è Debug Log</h2>
            <textarea id="log-output" rows="5" style="width: 100%; font-size: 0.75rem; background: #000; color: #0f0;"></textarea>
        </div>
    </div>
</div>

<script type="module">
    // ====================================================================
    // 1. FIREBASE CONFIG AND INITIALIZATION (CRITICAL FIXES APPLIED)
    // ====================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getFirestore, collection, getDocs, addDoc, query, orderBy, limit,
        onSnapshot, writeBatch, doc, setDoc, getDoc, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
        getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged,
        signOut, signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Provided Configuration (Manual Insertion) ---
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // NOTE: Hardcoded configuration provided by the user
    const FIREBASE_CONFIG = { 
        apiKey: "AIzaSyDWSebqVunmSzmw168fDZE_ePqoJ-_jsig", 
        authDomain: "bitven-6d42c.firebaseapp.com", 
        projectId: "bitven-6d42c", 
        storageBucket: "bitven-6d42c.firebasestorage.app", 
        messagingSenderId: "511584242303", 
        appId: "1:511584242303:web:bdfeac7801c4d17b254d4a" 
    };

    // --- Global App Variables ---
    let app, db, auth, currentUserId = null;
    let blocksData = [];
    let pendingSnapshotData = [];
    let isRequestMode = false;
    let isAuthReady = false;

    // --- Economic Constants ---
    const MINING_REWARD = 5;
    const TX_FEE = 0.01;
    const MINING_DIFFICULTY = 5; // Number of leading zeros required for PoW
    const BURN_ADDRESS = "0xBURN-BITVEN-SUPPLY";
    // ADMIN UID UPDATED AS REQUESTED
    const MASTER_ADMIN_UID = "pPLyBfQ68OVLx62NazbMeJw9lN63"; 
    const UNLIMITED_BALANCE = Number.MAX_SAFE_INTEGER;

    // --- Firebase Paths (Ensuring correct public path) ---
    const BASE_PATH = `artifacts/${APP_ID}/public/data/`;
    let CHAIN_REF, PENDING_TX_REF, USER_PROFILES_REF;
    
    // ====================================================================
    // 2. CORE BLOCKCHAIN CLASSES
    // ====================================================================

    class Transaction {
        constructor(fromAddress, toAddress, amount, message = '', isRequest = false) {
            this.fromAddress = fromAddress;
            this.toAddress = toAddress;
            this.amount = parseFloat(amount);
            this.timestamp = Date.now();
            this.message = message;
            this.isRequest = isRequest; // True if this is an invoice/request for payment
        }
        // Returns the effective debit amount (amount + fee)
        get effectiveAmount() {
            if (this.fromAddress === 'SYSTEM_REWARD' || this.isRequest) return 0;
            return this.amount + TX_FEE;
        }
    }

    class Block {
        constructor(index, transactions, previousHash = '') {
            this.index = index;
            this.timestamp = Date.now();
            this.transactions = transactions;
            this.previousHash = previousHash;
            this.nonce = 0;
            this.hash = this.calculateHash();
        }

        calculateHash() {
            return CryptoJS.SHA256(
                this.index + 
                this.previousHash + 
                this.timestamp + 
                this.nonce +
                JSON.stringify(this.transactions)
            ).toString();
        }

        mineBlock(difficulty) {
            const target = Array(difficulty + 1).join("0");
            let attempts = 0;
            while (this.hash.substring(0, difficulty) !== target) {
                this.nonce++;
                this.hash = this.calculateHash();
                attempts++;
                // Simple feedback for long mining operations (optional console log)
                if (attempts % 100000 === 0) {
                    console.log(`Mining... Attempts: ${attempts}`);
                }
            }
            console.log(`BLOCK MINED: ${this.hash} (Nonce: ${this.nonce}, Attempts: ${attempts})`);
        }
    }
    
    // ====================================================================
    // 3. AUTHENTICATION & INITIALIZATION
    // ====================================================================

    function getUID() {
        return auth.currentUser?.uid || null;
    }

    async function initializeFirebase() {
        if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.projectId) {
            console.error("Firebase config is missing or invalid. Application will not connect to Firestore.");
            document.getElementById('auth-status').textContent = "CONFIG ERROR: Check Firebase settings.";
            return;
        }

        try {
            app = initializeApp(FIREBASE_CONFIG);
            setLogLevel('Debug'); 
            log("Firebase App initialized. Debug logging enabled.");

            db = getFirestore(app);
            auth = getAuth(app);
            
            // Define collections only after db is initialized
            CHAIN_REF = collection(db, BASE_PATH + "blockchain_chain_v2");
            PENDING_TX_REF = collection(db, BASE_PATH + "pending_transactions_v2");
            USER_PROFILES_REF = collection(db, BASE_PATH + "user_profiles_v2");
            
            // Set App ID in UI
            document.getElementById('app-id').textContent = APP_ID;

            // Authentication flow
            log("Attempting authentication...");
            
            // FIX 1: Removed anonymous sign-in fallback to prevent 'auth/admin-restricted-operation' error.
            if (INITIAL_AUTH_TOKEN) {
                log("Sign-in detected. Attempting with custom token...");
                try {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                    log("Custom token sign-in successful.");
                } catch(e) {
                     log(`Custom token sign-in failed: ${e.message}. User must manually sign in.`, true);
                }
            } else {
                 log("No initial auth token provided. User must manually sign in.");
            }

            // Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isAuthReady = true;
                    document.getElementById('wallet-id').textContent = currentUserId;
                    document.getElementById('auth-status').textContent = `Signed in as: ${user.displayName || 'Anonymous'}`;
                    
                    // Enable/Disable buttons based on sign-in status
                    toggleUI(true);
                    
                    // Run initial data loads
                    setupRealtimeListeners();
                    saveUserProfile(user);
                } else {
                    currentUserId = null;
                    isAuthReady = false;
                    document.getElementById('wallet-id').textContent = 'N/A';
                    document.getElementById('auth-status').textContent = 'Signed Out';
                    toggleUI(false);
                }
                
                // Set admin status display
                const balanceSpan = document.getElementById('current-balance');
                if (currentUserId === MASTER_ADMIN_UID) {
                    balanceSpan.classList.add('balance-admin');
                    document.getElementById('mine-btn').disabled = true;
                } else {
                    balanceSpan.classList.remove('balance-admin');
                }
            });

        } catch (error) {
            log(`FATAL ERROR during Initialization: ${error.message}`, true);
            document.getElementById('auth-status').textContent = `FATAL ERROR: ${error.code || 'UNKNOWN'}`;
            toggleUI(false);
        }
    }
    
    // Utility to toggle button states
    function toggleUI(enabled) {
        document.getElementById('submit-tx-btn').disabled = !enabled;
        document.getElementById('mine-btn').disabled = !enabled || (currentUserId === MASTER_ADMIN_UID);
        document.getElementById('sign-in-btn').disabled = enabled;
        document.getElementById('sign-out-btn').disabled = !enabled;
    }

    // Helper logging function (same as debugger)
    function log(message, isError = false) {
        const logOutputElement = document.getElementById('log-output');
        if (logOutputElement) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${isError ? 'ERROR: ' : ''}${message}\n`;
            logOutputElement.value += logEntry;
            logOutputElement.scrollTop = logOutputElement.scrollHeight;
        }
        if (isError) {
            console.error(message);
        } else {
            console.log(message);
        }
    }

    // --- Public Functions for HTML `onclick` ---
    window.signInWithGoogle = () => {
        if (!auth) { log("Firebase Auth not initialized. Cannot sign in.", true); return; }
        const provider = new GoogleAuthProvider();
        // Forces account selection to make switching easier
        provider.setCustomParameters({ prompt: 'select_account' });
        signInWithPopup(auth, provider).catch((error) => {
            log(`Google Sign-In Error: ${error.message}`, true);
        });
    };

    window.signOutUser = () => {
        if (!auth) return;
        signOut(auth).then(() => {
            log("User signed out.");
        });
    };

    window.copyWalletId = () => {
        const id = getUID();
        if (id) {
            const textarea = document.createElement('textarea');
            textarea.value = id;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showStatusMessage('Wallet ID copied!', 'success');
        }
    };
    
    // ====================================================================
    // 4. DATA LOGIC & UI UPDATES
    // ====================================================================

    function setupRealtimeListeners() {
        if (!isAuthReady) return;

        // 1. Listen for Blockchain Chain changes
        onSnapshot(CHAIN_REF, (snapshot) => {
            blocksData = [];
            snapshot.forEach(doc => blocksData.push(doc.data()));
            blocksData.sort((a, b) => a.index - b.index);

            displayChain(blocksData);
            checkChainValidity(blocksData);
            window.calculateAndDisplayBalance(); // Recalculate balance on chain update
            displayTransactionHistory();
        }, (error) => log(`Chain Listener Error: ${error.message}`, true));

        // 2. Listen for Pending Transactions
        onSnapshot(PENDING_TX_REF, (snapshot) => {
            pendingSnapshotData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('pending-tx-count').textContent = pendingSnapshotData.length;
            displayInvoices(pendingSnapshotData);
            displayTransactionHistory();
        }, (error) => log(`Pending Tx Listener Error: ${error.message}`, true));
        
        // 3. Listen for User Profiles
        onSnapshot(USER_PROFILES_REF, (snapshot) => {
            displayUserDirectory(snapshot.docs.map(doc => doc.data()));
        }, (error) => log(`User Directory Listener Error: ${error.message}`, true));
    }
    
    async function saveUserProfile(user) {
        if (db && user.uid) {
            try {
                // Use setDoc to create or update the document with the UID as the ID
                await setDoc(doc(USER_PROFILES_REF, user.uid), {
                    uid: user.uid,
                    displayName: user.displayName || 'Anonymous User',
                    email: user.email || 'N/A',
                    lastActive: Date.now()
                });
            } catch (e) {
                log(`Error saving user profile: ${e.message}`, true);
            }
        }
    }


    window.calculateAndDisplayBalance = async () => {
        const walletAddress = getUID();
        const balanceSpan = document.getElementById('current-balance');
        if (!walletAddress) {
            balanceSpan.textContent = '0 BVN';
            return;
        }

        // Admin check: If admin, bypass balance calculation and display infinity
        if (walletAddress === MASTER_ADMIN_UID) {
            balanceSpan.textContent = '‚àû BVN (ADMIN MODE)';
            return;
        }

        let balance = 0;
        for (const block of blocksData) {
            for (const tx of block.transactions) {
                if (tx.fromAddress === walletAddress) {
                    // Deduct amount + fee
                    balance -= tx.amount + (tx.fromAddress !== 'SYSTEM_REWARD' && tx.amount > 0 ? TX_FEE : 0);
                }
                if (tx.toAddress === walletAddress) {
                    balance += tx.amount;
                }
            }
        }
        balanceSpan.textContent = `${balance.toFixed(2)} BVN`;
    }
    
    function showStatusMessage(message, type) {
        const statusElement = document.getElementById('tx-status');
        statusElement.textContent = message;
        statusElement.style.display = 'block';
        statusElement.className = `status-message status-${type}`;
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 5000);
    }
    
    // ====================================================================
    // 5. BLOCKCHAIN FUNCTIONS (Mining, Sending, Requesting)
    // ====================================================================

    window.mineBlock = async () => {
        if (!isAuthReady) { showStatusMessage("Auth not ready.", 'error'); return; }
        const miner = getUID();
        
        // Check if pending transactions exist
        if (pendingSnapshotData.length === 0) {
            showStatusMessage("No transactions to mine.", 'error');
            return;
        }
        
        document.getElementById('mine-btn').disabled = true;
        document.getElementById('mine-status').style.display = 'block';
        document.getElementById('mine-status').textContent = 'Mining in progress... This may take a moment.';

        // --- 1. Get Pending Transactions and Calculate Fees ---
        const transactionsToMine = pendingSnapshotData.map(doc => {
            // Remove the Firestore ID before putting it in the block
            const { id, ...data } = doc;
            return data;
        });

        let totalFees = 0;
        for (const tx of transactionsToMine) {
            if (!tx.isRequest) {
                totalFees += TX_FEE;
            }
        }

        // --- 2. Create Mining Reward Transaction ---
        const rewardTx = new Transaction('SYSTEM_REWARD', miner, MINING_REWARD + totalFees, `Block reward + ${totalFees.toFixed(2)} BVN in fees.`);
        transactionsToMine.push(rewardTx);

        // --- 3. Get Last Block Hash and Index ---
        const lastBlock = blocksData[blocksData.length - 1];
        const previousHash = lastBlock ? lastBlock.hash : '0';
        const nextIndex = lastBlock ? lastBlock.index + 1 : 0;
        
        // --- 4. Create and Mine New Block (Proof-of-Work) ---
        const newBlock = new Block(nextIndex, transactionsToMine, previousHash);
        
        // **Blocking Operation: PoW Calculation**
        newBlock.mineBlock(MINING_DIFFICULTY);
        
        // --- 5. Batch Write to Firestore ---
        const batch = writeBatch(db);

        // A. Add the new block to the chain
        batch.set(doc(CHAIN_REF), { ...newBlock });

        // B. Delete all pending transactions that were just mined
        pendingSnapshotData.forEach(doc => {
            batch.delete(doc(PENDING_TX_REF, doc.id));
        });

        try {
            await batch.commit();
            showStatusMessage(`Block ${newBlock.index} mined successfully! Reward: ${rewardTx.amount.toFixed(2)} BVN.`, 'success');
        } catch (e) {
            showStatusMessage(`Error committing block: ${e.message}`, 'error');
            console.error("Error mining block:", e);
        } finally {
            document.getElementById('mine-btn').disabled = false;
            document.getElementById('mine-status').style.display = 'none';
        }
    };


    function validateTransactionInput(toAddress, amount, isSending) {
        const isAdmin = getUID() === MASTER_ADMIN_UID;
        const currentBalanceText = document.getElementById('current-balance').textContent.split(' ')[0];
        
        if (!toAddress || toAddress.length < 5) return "Invalid recipient ID.";
        if (isNaN(amount) || amount <= 0) return "Invalid amount. Must be positive.";
        if (toAddress === getUID()) return "Cannot send or request funds to/from yourself.";
        if (toAddress === BURN_ADDRESS && amount <= 0) return "Must burn a positive amount.";
        
        if (isSending) {
            // Check balance only if not admin
            if (!isAdmin) {
                const effectiveAmount = amount + TX_FEE;
                const currentBalance = parseFloat(currentBalanceText);
                if (currentBalance < effectiveAmount) {
                    return `Insufficient funds. Required: ${effectiveAmount.toFixed(2)} BVN (includes ${TX_FEE} fee).`;
                }
            }
        }
        return null; // Validation passed
    }

    // --- Send Transaction / Submit Request ---
    document.getElementById('tx-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const toAddress = document.getElementById('recipient-id').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const message = document.getElementById('message').value.trim();
        const fromAddress = getUID();
        
        let recipient, sender, txIsRequest;

        if (isRequestMode) {
            // Request: current user (fromAddress) is the recipient, they are requesting from (toAddress)
            sender = toAddress; // The person being invoiced
            recipient = fromAddress; // Current user
            txIsRequest = true;
        } else {
            // Send: current user is the sender
            sender = fromAddress;
            recipient = toAddress;
            txIsRequest = false;
        }

        const error = validateTransactionInput(txIsRequest ? sender : recipient, amount, !txIsRequest);
        if (error) {
            showStatusMessage(error, 'error');
            return;
        }

        const newTx = new Transaction(sender, recipient, amount, message, txIsRequest);
        
        // Apply fee deduction message if sending
        if (!txIsRequest) {
            newTx.message = newTx.message ? `${newTx.message} (Fee: ${TX_FEE} BVN)` : `Payment (Fee: ${TX_FEE} BVN)`;
        }

        addDoc(PENDING_TX_REF, { ...newTx })
            .then(() => {
                showStatusMessage(txIsRequest ? "Invoice submitted successfully. Awaiting payment." : "Transaction submitted to mining pool.", 'success');
                document.getElementById('recipient-id').value = '';
                document.getElementById('amount').value = '1';
                document.getElementById('message').value = '';
            })
            .catch(e => {
                showStatusMessage(`Error submitting: ${e.message}`, 'error');
                console.error("Error submitting transaction: ", e);
            });
    });

    // FIX 2: Correctly reference the toggle button using its new ID
    window.toggleRequestMode = () => {
        isRequestMode = !isRequestMode;
        const header = document.getElementById('tx-header');
        const recipientInput = document.getElementById('recipient-id');
        const submitBtn = document.getElementById('submit-tx-btn');
        const toggleBtn = document.getElementById('toggle-request-mode-btn'); 
        const messageInput = document.getElementById('message');

        if (isRequestMode) {
            header.textContent = 'üßæ Request Funds (Invoice)';
            recipientInput.placeholder = "Wallet ID of Debtor (person who will pay)";
            submitBtn.textContent = 'Submit Invoice Request';
            toggleBtn.textContent = 'Switch to Send BitVen';
            messageInput.placeholder = "Reason for invoice (e.g., website fee)";
        } else {
            header.textContent = 'üí∏ Send BitVen';
            recipientInput.placeholder = "Recipient Wallet ID (UID)";
            submitBtn.textContent = 'Submit Payment';
            toggleBtn.textContent = 'Switch to Invoice Request';
            messageInput.placeholder = "Message (e.g., for rent)";
        }
    };
    
    window.payInvoice = (sender, amount) => {
        // Switch to send mode and populate the form
        if (isRequestMode) {
            window.toggleRequestMode();
        }
        document.getElementById('recipient-id').value = sender;
        document.getElementById('amount').value = amount;
        showStatusMessage(`Form populated to pay ${amount} BVN to ${sender.substring(0, 8)}...`, 'success');
    };

    // ====================================================================
    // 6. DISPLAY FUNCTIONS
    // ====================================================================
    
    function displayChain(blocks) {
        const output = document.getElementById('chain-output');
        if (blocks.length === 0) {
            output.innerHTML = '<p>The blockchain is empty. Mine the first (Genesis) block!</p>';
            return;
        }
        output.innerHTML = '';
        document.getElementById('chain-length').textContent = blocks.length;

        blocks.forEach(block => {
            let totalFeesCollected = 0;
            const txList = block.transactions.map(tx => {
                let txClass = '';
                let txType = '';
                let txDisplay = '';

                if (tx.fromAddress === 'SYSTEM_REWARD' && tx.toAddress !== BURN_ADDRESS) {
                    txType = 'REWARD';
                    txClass = 'tx-type-reward';
                    txDisplay = `Miner Reward: ${tx.amount.toFixed(2)} BVN`;
                } else if (tx.toAddress === BURN_ADDRESS) {
                    txType = 'BURN';
                    txClass = 'tx-type-burn';
                    txDisplay = `Burned ${tx.amount.toFixed(2)} BVN`;
                } else if (tx.isRequest) {
                    txType = 'REQUEST (Pending)';
                    txClass = 'tx-type-request';
                    txDisplay = `Request: ${tx.amount.toFixed(2)} BVN`;
                }
                 else {
                    // Regular transaction
                    if (!tx.isRequest) {
                         totalFeesCollected += TX_FEE;
                    }
                    txType = 'Payment';
                    txDisplay = `Send: ${tx.amount.toFixed(2)} BVN`;
                }

                return `<li><span class="${txClass}">${txType}</span> | ${txDisplay} | From: ${tx.fromAddress.substring(0, 8)}... | To: ${tx.toAddress.substring(0, 8)}... | Msg: ${tx.message || 'N/A'}</li>`;
            }).join('');
            
            const blockHtml = `
                <div class="block-card">
                    <div class="block-header">Block #${block.index} (T: ${new Date(block.timestamp).toLocaleTimeString()})</div>
                    <p>Fees: <span class="tx-type-reward">${totalFeesCollected.toFixed(2)} BVN</span></p>
                    <p>Hash: <code>${block.hash.substring(0, 20)}...</code></p>
                    <p>Prev Hash: <code>${block.previousHash.substring(0, 20)}...</code></p>
                    <div class="tx-list">
                        <details>
                            <summary>Transactions (${block.transactions.length})</summary>
                            <ul>${txList}</ul>
                        </details>
                    </div>
                </div>
            `;
            output.innerHTML += blockHtml;
        });
    }

    function checkChainValidity(chain) {
        let isValid = true;
        for (let i = 1; i < chain.length; i++) {
            const currentBlock = chain[i];
            const previousBlock = chain[i - 1];
            
            // Re-calculate hash to ensure integrity
            const testBlock = new Block(currentBlock.index, currentBlock.transactions, currentBlock.previousHash);
            testBlock.nonce = currentBlock.nonce; // Set nonce from stored block
            const calculatedHash = testBlock.calculateHash();

            // 1. Check if the block's stored hash is correct
            if (currentBlock.hash !== calculatedHash) {
                log(`Chain Invalid: Block #${currentBlock.index} hash mismatch.`, true);
                isValid = false;
                break;
            }

            // 2. Check if the previousHash pointer is correct
            if (currentBlock.previousHash !== previousBlock.hash) {
                log(`Chain Invalid: Block #${currentBlock.index} link broken.`, true);
                isValid = false;
                break;
            }
        }
        document.getElementById('chain-valid').textContent = isValid ? '‚úÖ VALID' : '‚ùå INVALID';
        document.getElementById('chain-valid').style.color = isValid ? '#059669' : '#ef4444';
    }

    function displayUserDirectory(profiles) {
        const output = document.getElementById('directory-list');
        output.innerHTML = '';

        if (profiles.length === 0) {
            output.innerHTML = '<p>No other users online yet.</p>';
            return;
        }

        profiles.forEach(p => {
            if (p.uid === getUID()) return; // Don't list self
            
            const profileHtml = `
                <div class="directory-item">
                    <p><strong>${p.displayName}</strong> (${p.email})</p>
                    <p>ID: <code>${p.uid}</code></p>
                    <button onclick="window.payInvoice('${p.uid}', 1)" style="background-color: var(--color-secondary); padding: 5px 10px; margin-top: 5px;">
                        Send 1 BVN to User
                    </button>
                    <button class="copy-btn" onclick="window.copyIdToClipboard('${p.uid}')" title="Copy ID">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7 17a2 2 0 01-2-2V5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H7zM7 5v10h8V5H7zM5 5V3h2V1H5a2 2 0 00-2 2v2h2zM15 15v2h2v-2h-2zM3 15v2H1v-2h2z"/></svg>
                    </button>
                </div>
            `;
            output.innerHTML += profileHtml;
        });
    }
    
    window.copyIdToClipboard = (id) => {
        const textarea = document.createElement('textarea');
        textarea.value = id;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showStatusMessage(`Copied user ID: ${id.substring(0, 8)}...`, 'success');
    };

    function displayInvoices(pendingTxs) {
        const output = document.getElementById('invoices-output');
        const myUid = getUID();
        
        const myInvoices = pendingTxs.filter(tx => tx.isRequest && tx.toAddress === myUid);
        output.innerHTML = '';

        if (myInvoices.length === 0) {
            output.innerHTML = '<p>No pending invoices sent to you.</p>';
            return;
        }

        myInvoices.forEach(tx => {
            const invoiceHtml = `
                <div class="tx-history-item" style="border-left: 5px solid #f97316;">
                    <p><span class="tx-type-request">INVOICE</span> from <strong>${tx.fromAddress.substring(0, 8)}...</strong></p>
                    <p>Amount Due: <strong>${tx.amount.toFixed(2)} BVN</strong></p>
                    <p>Reason: ${tx.message || 'N/A'}</p>
                    <button onclick="window.payInvoice('${tx.fromAddress}', ${tx.amount})" style="background-color: var(--color-burn); padding: 5px 10px; margin-top: 10px;">
                        Pay Invoice
                    </button>
                </div>
            `;
            output.innerHTML += invoiceHtml;
        });
    }

    function displayTransactionHistory() {
        if (!isAuthReady) return;
        const myUid = getUID();
        const output = document.getElementById('history-output');
        
        const allActivity = [];

        // 1. Mined Transactions (from blocks)
        blocksData.forEach(block => {
            block.transactions.forEach(tx => {
                if (tx.fromAddress === myUid || tx.toAddress === myUid) {
                    allActivity.push({ ...tx, type: 'MINED', blockIndex: block.index, timestamp: block.timestamp });
                }
            });
        });

        // 2. Pending Transactions/Requests
        pendingSnapshotData.forEach(tx => {
             if (tx.fromAddress === myUid || tx.toAddress === myUid) {
                 allActivity.push({ ...tx, type: 'PENDING', timestamp: tx.timestamp });
            }
        });

        // Sort by timestamp (most recent first)
        allActivity.sort((a, b) => b.timestamp - a.timestamp);

        if (allActivity.length === 0) {
            output.innerHTML = '<p>No transactions found in your history.</p>';
            return;
        }

        output.innerHTML = allActivity.map(item => {
            let label, status, amountDisplay, color;
            
            if (item.type === 'MINED') {
                status = `MINED (Block #${item.blockIndex})`;
                color = '#059669'; // Green
                
                if (item.fromAddress === 'SYSTEM_REWARD' && item.toAddress === myUid) {
                    label = 'MINED REWARD';
                    amountDisplay = `+${item.amount.toFixed(2)} BVN (Miner)`;
                } else if (item.fromAddress === myUid) {
                    label = item.toAddress === BURN_ADDRESS ? 'SENT (BURN)' : 'SENT';
                    amountDisplay = `-${(item.amount + TX_FEE).toFixed(2)} BVN`;
                } else if (item.toAddress === myUid) {
                    label = 'RECEIVED';
                    amountDisplay = `+${item.amount.toFixed(2)} BVN`;
                }
            } else { // PENDING
                status = 'PENDING';
                color = '#f59e0b'; // Amber
                
                if (item.isRequest && item.toAddress === myUid) {
                    label = 'INVOICE RECEIVED';
                    amountDisplay = `Due: ${item.amount.toFixed(2)} BVN`;
                    color = '#f97316'; // Orange
                } else if (item.isRequest && item.fromAddress === myUid) {
                    label = 'INVOICE SENT';
                    amountDisplay = `Request: ${item.amount.toFixed(2)} BVN`;
                } else if (item.fromAddress === myUid) {
                    label = 'SENT (Pending)';
                    amountDisplay = `-${(item.amount + TX_FEE).toFixed(2)} BVN`;
                } else if (item.toAddress === myUid) {
                    label = 'RECEIVED (Pending)';
                    amountDisplay = `+${item.amount.toFixed(2)} BVN`;
                }
            }
            
            return `
                <div class="tx-history-item" style="border-left: 5px solid ${color};">
                    <p style="display: flex; justify-content: space-between; font-weight: 700;">
                        <span>${label}</span>
                        <span style="color: ${color};">${amountDisplay}</span>
                    </p>
                    <p style="font-size: 0.8rem; color: var(--color-text-subtle);">
                        ${status} | T: ${new Date(item.timestamp).toLocaleString()}
                    </p>
                    <p style="font-size: 0.8rem; margin-top: 5px; word-break: break-all;">
                        Msg: ${item.message || 'N/A'}
                    </p>
                </div>
            `;
        }).join('');
    }

    // --- Start Initialization ---
    window.addEventListener('load', initializeFirebase);
</script>
</body>
</html>

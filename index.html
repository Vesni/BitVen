<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen-Forca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for font and scrollbar, maximizing Tailwind utility use */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 - cleaner background */
        }
        
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* Gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: transparent;
        }

        /* Utility classes for primary branding */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #059669; /* Emerald-600 */
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background-color: #6ee7b7; /* Emerald-300 */
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: white;
            color: #10b981;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            border: 2px solid #10b981;
            transition: all 0.2s;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #f0fdf4; /* Emerald-50 */
        }
        .tx-input {
             @apply mt-1 block w-full rounded-lg border-2 border-gray-200 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-900 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.5 2.5a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                BitVen - By Vesni
            </h1>
            <p id="auth-status" class="text-sm font-semibold mt-2 text-gray-500"></p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Col 1: Wallet & Send Form -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Wallet/Auth Card -->
                <div class="card p-6 border-t-4 border-emerald-500">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Wallet</h2>
                    <div class="space-y-4">
                        <div class="bg-gray-100 p-4 rounded-xl flex flex-col">
                            <span class="text-sm font-medium text-gray-500 mb-1">Wallet ID (UID)</span>
                            <code id="user-uid" class="text-sm font-mono text-gray-700 break-all truncate">Loading...</code>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-xl flex justify-between items-center shadow-inner">
                            <span class="text-lg font-semibold text-emerald-800">Current Balance</span>
                            <span id="current-balance" class="text-3xl font-extrabold text-emerald-700">0.00 BVN</span>
                        </div>
                        <button id="copy-uid-btn" class="btn-secondary w-full text-center mt-2 text-sm">Copy Wallet ID</button>
                    </div>
                </div>

                <!-- Send/Invoice Form Card -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Transaction Hub</h2>
                    <div class="flex space-x-2 mb-6">
                        <button id="mode-send" class="flex-1 btn-primary text-sm" data-mode="send">Send Payment</button>
                        <button id="mode-invoice" class="flex-1 btn-secondary text-sm" data-mode="invoice">Request Invoice</button>
                    </div>

                    <div id="message-box" class="hidden p-3 rounded-lg text-sm mb-4" role="alert"></div>

                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="recipient-uid" class="block text-sm font-medium text-gray-700">Recipient Wallet ID</label>
                            <input type="text" id="recipient-uid" required class="tx-input" placeholder="Enter Wallet ID">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Amount (BVN)</label>
                            <input type="number" id="amount" required min="0.01" step="0.01" class="tx-input" placeholder="e.g., 50.00">
                            <p id="fee-note" class="text-xs text-gray-500 mt-1">Fee: 0.01 BVN (Burned)</p>
                        </div>
                        <button type="submit" id="submit-btn" class="btn-primary w-full flex items-center justify-center transition duration-150">
                            <span id="submit-text">Send 0.00 BVN</span>
                            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Col 2: Ledger & Invoices -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Pending Invoices -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pending Invoices TO YOU</h2>
                    <div id="pending-invoices" class="space-y-4 custom-scrollbar overflow-y-auto max-h-64 pr-2">
                        <p class="text-gray-500 text-sm" id="no-invoices">No pending requests.</p>
                    </div>
                </div>

                <!-- Blockchain History -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Blockchain Ledger
                        <span id="chain-length" class="text-sm font-bold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">Blocks: 0</span>
                    </h2>
                    <div id="blockchain-history" class="space-y-4 custom-scrollbar overflow-y-auto max-h-96 pr-2">
                        <p class="text-gray-500 text-sm" id="no-blocks">Listening for first block...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Directory (Below the main grid) -->
        <div class="card p-6 mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Live User Directory</h2>
            <div id="user-directory" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <p class="text-gray-500 text-sm col-span-full">Loading active users...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables (Mandatory Canvas/Firebase Setup)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configuration
        setLogLevel('Debug');
        const FIREBASE_APP = initializeApp(firebaseConfig);
        const DB = getFirestore(FIREBASE_APP);
        const AUTH = getAuth(FIREBASE_APP);
        
        // Firestore Path Constants
        const ARTIFACT_PATH = `artifacts/${appId}`;
        const PUBLIC_DATA_PATH = `${ARTIFACT_PATH}/public/data`;
        const BLOCKCHAIN_COLLECTION = 'blockchain_chain_v2';
        const INVOICES_COLLECTION = 'invoices_v2';
        const USER_PROFILES_COLLECTION = 'user_profiles_v2';
        const BURN_ADDRESS = '0xBURN-BITVEN-SUPPLY';
        const ADMIN_UID = 'admin-BVN-master'; // Hardcoded master admin for balance

        // State Variables
        let currentUID = null;
        let isAuthReady = false;
        let chain = [];
        let userProfiles = {};
        let currentMode = 'send';
        const TRANSACTION_FEE = 0.01;

        // DOM Elements
        const authStatusEl = document.getElementById('auth-status');
        const userUidEl = document.getElementById('user-uid');
        const balanceEl = document.getElementById('current-balance');
        const messageBoxEl = document.getElementById('message-box');
        const submitBtn = document.getElementById('submit-btn');
        const submitTextEl = document.getElementById('submit-text');
        const loadingSpinnerEl = document.getElementById('loading-spinner');
        const formEl = document.getElementById('transaction-form');
        const recipientInput = document.getElementById('recipient-uid');
        const amountInput = document.getElementById('amount');
        const feeNoteEl = document.getElementById('fee-note');

        // Utility Functions
        const createHash = (data) => {
            // Simple hash for demo: Base64 encode JSON data
            return btoa(JSON.stringify(data)).substring(0, 40);
        };

        const createUUID = () => crypto.randomUUID();

        const formatCurrency = (amount) => {
            if (amount === Infinity) return '∞ BVN';
            return `${parseFloat(amount).toFixed(2)} BVN`;
        };
        
        const showMessage = (text, type = 'error') => {
            messageBoxEl.textContent = text;
            messageBoxEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-red-50', 'text-red-800', 'bg-emerald-50', 'text-emerald-800', 'border-red-500', 'border-emerald-500');
            
            if (type === 'error') {
                messageBoxEl.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-400');
            } else {
                messageBoxEl.classList.add('bg-emerald-50', 'text-emerald-800', 'border', 'border-emerald-400');
            }
            messageBoxEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageBoxEl.classList.add('hidden');
            }, 5000);
        };

        // --- Data Serialization Fix ---
        /**
         * Converts a Block object (which might be an internal class/instance) into a
         * plain, serializable object for Firestore. This prevents the "custom object" error.
         * @param {Object} block The block object structure.
         * @returns {Object} A plain JavaScript object suitable for Firestore.
         */
        const serializeBlock = (block) => {
            // Ensure transactions are also mapped to plain objects, just in case.
            const serializedTransactions = block.transactions.map(tx => ({
                id: tx.id || createUUID(), // Ensure UUID for transaction if not present
                from: tx.from,
                to: tx.to,
                amount: parseFloat(tx.amount), // Ensure number type
                fee: parseFloat(tx.fee) || 0,
                timestamp: tx.timestamp,
                isFeeTransaction: tx.isFeeTransaction || false,
                signature: tx.signature || 'NONE'
            }));

            return {
                hash: block.hash,
                previousHash: block.previousHash,
                timestamp: block.timestamp,
                transactions: serializedTransactions,
                // Block height is not needed for storage as Firestore key is ID
            };
        };

        // --- Core Blockchain Logic ---

        // Helper to find the last valid block hash
        const getLatestBlockHash = () => {
            if (chain.length === 0) return '0';
            return chain[chain.length - 1].hash;
        };

        // Creates a new Transaction object (plain JS object)
        const createTransaction = (from, to, amount, fee = 0, isFee = false) => {
            return {
                id: createUUID(),
                from: from,
                to: to,
                amount: parseFloat(amount),
                fee: parseFloat(fee),
                timestamp: Date.now(),
                isFeeTransaction: isFee,
                signature: 'NONE', // No real signing for this demo
            };
        };

        // Creates a new Block object (plain JS object)
        const createBlock = (transactions) => {
            const previousHash = getLatestBlockHash();
            const timestamp = Date.now();
            const blockData = { previousHash, timestamp, transactions };
            const hash = createHash(blockData);

            return { hash, ...blockData };
        };

        // --- Firestore Operations ---

        /**
         * Adds a new block to the public blockchain collection.
         * @param {Object} block The new block object (will be serialized before save).
         */
        const addBlockToChain = async (block) => {
            const blockCollectionRef = collection(DB, PUBLIC_DATA_PATH, BLOCKCHAIN_COLLECTION);
            
            // CRITICAL FIX: Ensure the block object is a plain map before saving.
            const blockDataToSave = serializeBlock(block);

            try {
                // Use the block hash as the document ID
                await setDoc(doc(blockCollectionRef, blockDataToSave.hash), blockDataToSave);
                console.log(`Block successfully added with hash: ${blockDataToSave.hash}`);
            } catch (error) {
                console.error("Error writing block to Firestore:", error);
                showMessage(`Blockchain error: Could not write block. ${error.message}`);
                // Re-enable form if transaction fails
                setLoading(false);
            }
        };

        // --- Balance and Chain Management ---

        const calculateBalance = (userUid) => {
            if (userUid === ADMIN_UID) return Infinity;

            let balance = 0;
            chain.forEach(block => {
                if (block.transactions) {
                    block.transactions.forEach(tx => {
                        // All amounts are positive. We deduct/add based on from/to.
                        const amount = tx.amount;
                        const fee = tx.fee || 0;

                        if (tx.from === userUid) {
                            // Deduct sent amount and the fee
                            balance -= amount;
                            balance -= fee;
                        }
                        if (tx.to === userUid) {
                            // Add received amount
                            balance += amount;
                        }
                    });
                }
            });
            return balance;
        };

        const updateUIBalance = () => {
            const balance = calculateBalance(currentUID);
            balanceEl.textContent = formatCurrency(balance);

            if (balance < 0) {
                balanceEl.classList.remove('text-emerald-700');
                balanceEl.classList.add('text-red-700');
            } else {
                balanceEl.classList.add('text-emerald-700');
                balanceEl.classList.remove('text-red-700');
            }
        };

        // --- Main Event Handlers ---

        const setLoading = (isLoading) => {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                loadingSpinnerEl.classList.remove('hidden');
                submitTextEl.textContent = 'Processing...';
            } else {
                loadingSpinnerEl.classList.add('hidden');
                const amount = parseFloat(amountInput.value) || 0;
                if (currentMode === 'send') {
                    submitTextEl.textContent = `Send ${formatCurrency(amount)}`;
                } else {
                    submitTextEl.textContent = `Request Invoice for ${formatCurrency(amount)}`;
                }
            }
        };

        const switchMode = (mode) => {
            currentMode = mode;
            const sendBtn = document.getElementById('mode-send');
            const invoiceBtn = document.getElementById('mode-invoice');

            // Reset styles
            sendBtn.classList.remove('btn-primary', 'btn-secondary');
            invoiceBtn.classList.remove('btn-primary', 'btn-secondary');

            if (mode === 'send') {
                sendBtn.classList.add('btn-primary');
                invoiceBtn.classList.add('btn-secondary');
                feeNoteEl.classList.remove('hidden');
                recipientInput.placeholder = "Recipient's Wallet ID";
            } else { // invoice
                invoiceBtn.classList.add('btn-primary');
                sendBtn.classList.add('btn-secondary');
                feeNoteEl.classList.add('hidden');
                recipientInput.placeholder = "Payer's Wallet ID";
            }
            updateSubmitButtonText();
        };

        const updateSubmitButtonText = () => {
            const amount = parseFloat(amountInput.value) || 0;
            if (currentMode === 'send') {
                submitTextEl.textContent = `Send ${formatCurrency(amount)}`;
            } else {
                submitTextEl.textContent = `Request Invoice for ${formatCurrency(amount)}`;
            }
        };

        const handleSendTransaction = async (recipient, amount) => {
            setLoading(true);

            // 1. Validation
            const totalCost = amount + TRANSACTION_FEE;
            const currentBalance = calculateBalance(currentUID);

            if (recipient === currentUID) {
                showMessage("Error: Cannot send funds to your own Wallet ID.");
                setLoading(false);
                return;
            }

            if (currentBalance !== Infinity && currentBalance < totalCost) {
                showMessage(`Error: Insufficient funds. You need ${formatCurrency(totalCost)}, but only have ${formatCurrency(currentBalance)}.`);
                setLoading(false);
                return;
            }

            // 2. Create Transactions (Payment and Fee)
            const txs = [
                // Tx 1: Sender -> Recipient (Amount)
                createTransaction(currentUID, recipient, amount),
                // Tx 2: Sender -> Burn (Fee)
                createTransaction(currentUID, BURN_ADDRESS, TRANSACTION_FEE, 0.00, true)
            ];

            // 3. Create and Add Block
            const newBlock = createBlock(txs);
            await addBlockToChain(newBlock);

            // 4. Cleanup
            recipientInput.value = '';
            amountInput.value = '';
            updateSubmitButtonText();
            setLoading(false);
            showMessage(`Payment of ${formatCurrency(amount)} successful! Block added to chain.`, 'success');
        };

        const handleInvoiceRequest = async (payerUid, amount) => {
            setLoading(true);

            const invoiceCollectionRef = collection(DB, PUBLIC_DATA_PATH, INVOICES_COLLECTION);
            
            if (payerUid === currentUID) {
                showMessage("Error: Cannot request an invoice from yourself.");
                setLoading(false);
                return;
            }

            try {
                await addDoc(invoiceCollectionRef, {
                    issuerUid: currentUID,
                    payerUid: payerUid,
                    amount: parseFloat(amount),
                    timestamp: Date.now(),
                    status: 'pending'
                });
                recipientInput.value = '';
                amountInput.value = '';
                updateSubmitButtonText();
                setLoading(false);
                showMessage(`Invoice of ${formatCurrency(amount)} successfully requested from ${payerUid}.`, 'success');
            } catch (error) {
                console.error("Error creating invoice:", error);
                setLoading(false);
                showMessage(`Invoice error: Could not create request. ${error.message}`);
            }
        };

        const payInvoice = async (invoiceId, payerUid, issuerUid, amount) => {
            if (payerUid !== currentUID) {
                showMessage("Error: You are not the designated payer for this invoice.");
                return;
            }

            // Temporarily disable form/buttons to prevent double-click
            setLoading(true);
            
            // Check balance
            const totalCost = amount + TRANSACTION_FEE;
            const currentBalance = calculateBalance(currentUID);
            
            if (currentBalance !== Infinity && currentBalance < totalCost) {
                showMessage(`Error: Insufficient funds to clear this invoice. Required: ${formatCurrency(totalCost)}.`);
                setLoading(false);
                return;
            }

            const batch = writeBatch(DB);
            
            // 1. Create Transactions (Payment and Fee)
            const txs = [
                createTransaction(currentUID, issuerUid, amount),
                createTransaction(currentUID, BURN_ADDRESS, TRANSACTION_FEE, 0.00, true)
            ];

            // 2. Create and Add Block
            const newBlock = createBlock(txs);
            
            // CRITICAL FIX: Serialize block data before adding to batch
            const blockDataToSave = serializeBlock(newBlock);

            const blockDocRef = doc(DB, PUBLIC_DATA_PATH, BLOCKCHAIN_COLLECTION, newBlock.hash);
            batch.set(blockDocRef, blockDataToSave);

            // 3. Delete/Update Invoice Status
            const invoiceDocRef = doc(DB, PUBLIC_DATA_PATH, INVOICES_COLLECTION, invoiceId);
            // Delete the invoice after successful payment
            batch.delete(invoiceDocRef);

            try {
                await batch.commit();
                showMessage(`Invoice ${invoiceId.substring(0, 8)} cleared successfully!`, 'success');
            } catch (error) {
                console.error("Error clearing invoice batch:", error);
                showMessage(`Payment failed. Please try again. ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        // --- Real-time Listeners ---

        const startBlockchainListener = () => {
            const blockCollectionRef = collection(DB, PUBLIC_DATA_PATH, BLOCKCHAIN_COLLECTION);
            // Simple query to get all documents (no sorting to avoid index requirements)
            onSnapshot(blockCollectionRef, (snapshot) => {
                const newChain = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure the chain array is clean, structured data (not custom objects)
                    newChain.push(data);
                });

                // Sort chain by timestamp to maintain order for balance calculation
                newChain.sort((a, b) => a.timestamp - b.timestamp);

                chain = newChain;
                renderBlockchainHistory();
                updateUIBalance();
            }, (error) => {
                console.error("Blockchain Listener Error:", error);
                document.getElementById('no-blocks').textContent = `Blockchain Listener Error: ${error.message}`;
            });
        };

        const startInvoicesListener = () => {
            const invoiceCollectionRef = collection(DB, PUBLIC_DATA_PATH, INVOICES_COLLECTION);
            
            if (!currentUID) return; // Wait for auth

            // Query for invoices where the current user is the payer
            const q = query(invoiceCollectionRef, where("payerUid", "==", currentUID));

            onSnapshot(q, (snapshot) => {
                const invoicesContainer = document.getElementById('pending-invoices');
                invoicesContainer.innerHTML = ''; // Clear previous
                
                if (snapshot.empty) {
                    document.getElementById('no-invoices').classList.remove('hidden');
                    return;
                }
                document.getElementById('no-invoices').classList.add('hidden');

                snapshot.forEach(doc => {
                    const invoice = doc.data();
                    const invoiceId = doc.id;
                    
                    const invoiceEl = document.createElement('div');
                    invoiceEl.className = 'card p-4 bg-red-50 border border-red-300 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4 rounded-xl';
                    invoiceEl.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-sm font-medium text-red-800">Request from <code class="text-xs font-mono text-red-600 break-all">${invoice.issuerUid}</code></p>
                            <p class="text-2xl font-extrabold text-red-900 mt-1">${formatCurrency(invoice.amount)}</p>
                        </div>
                        <button class="pay-invoice-btn btn-primary bg-red-600 hover:bg-red-700 w-full sm:w-auto text-sm"
                            data-id="${invoiceId}"
                            data-payer="${invoice.payerUid}"
                            data-issuer="${invoice.issuerUid}"
                            data-amount="${invoice.amount}">
                            Pay Now
                        </button>
                    `;
                    invoicesContainer.appendChild(invoiceEl);
                });

                // Attach click handlers to new pay buttons
                invoicesContainer.querySelectorAll('.pay-invoice-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const { id, payer, issuer, amount } = e.currentTarget.dataset;
                        payInvoice(id, payer, issuer, parseFloat(amount));
                    });
                });

            }, (error) => {
                console.error("Invoice Listener Error:", error);
                document.getElementById('no-invoices').textContent = `Invoice Listener Error: ${error.message}`;
            });
        };

        const startUserProfilesListener = () => {
            const profileCollectionRef = collection(DB, PUBLIC_DATA_PATH, USER_PROFILES_COLLECTION);
            onSnapshot(profileCollectionRef, (snapshot) => {
                userProfiles = {};
                const directoryEl = document.getElementById('user-directory');
                directoryEl.innerHTML = '';
                
                const currentUsers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    userProfiles[data.uid] = data;
                    currentUsers.push(data);
                });

                currentUsers.sort((a, b) => a.uid.localeCompare(b.uid)).forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'card p-4 text-center bg-gray-50 hover:bg-emerald-50 cursor-pointer rounded-xl transition duration-150 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm';
                    userEl.innerHTML = `
                        <p class="text-base font-semibold text-gray-800 truncate">${user.name}</p>
                        <code class="text-xs font-mono text-gray-600 break-all truncate block mt-1">${user.uid}</code>
                    `;
                    userEl.addEventListener('click', () => {
                        recipientInput.value = user.uid;
                        showMessage(`Recipient set to ${user.name}`, 'success');
                    });
                    directoryEl.appendChild(userEl);
                });

            }, (error) => {
                console.error("User Profiles Listener Error:", error);
                directoryEl.innerHTML = `<p class="text-red-500 col-span-full">Error loading users: ${error.message}</p>`;
            });
        };

        // --- Rendering ---

        const renderBlockchainHistory = () => {
            const historyEl = document.getElementById('blockchain-history');
            historyEl.innerHTML = ''; // Clear previous
            document.getElementById('chain-length').textContent = `Blocks: ${chain.length}`;

            if (chain.length === 0) {
                document.getElementById('no-blocks').classList.remove('hidden');
                return;
            }
            document.getElementById('no-blocks').classList.add('hidden');

            // Render in reverse chronological order
            chain.slice().reverse().forEach((block, index) => {
                const blockHeight = chain.length - index;

                const blockEl = document.createElement('div');
                blockEl.className = 'p-5 border-l-4 border-emerald-500 bg-white rounded-xl shadow-md';
                
                let txListHTML = '';
                block.transactions.forEach(tx => {
                    let type, icon, colorClass, detailText;
                    
                    const amountDisplay = formatCurrency(tx.amount + tx.fee);
                    const txId = tx.id.substring(0, 8);

                    if (tx.isFeeTransaction) {
                        type = 'FEE';
                        icon = '🔥';
                        colorClass = 'text-yellow-600';
                        detailText = `<span class="font-mono text-xs text-gray-500 break-all">Burn Address: ${BURN_ADDRESS.substring(0, 10)}...</span>`;
                    } else if (tx.from === currentUID) {
                        type = 'SENT';
                        icon = '💸';
                        colorClass = 'text-red-600';
                        detailText = `<span class="font-mono text-xs text-gray-500 break-all">To: ${tx.to}</span>`;
                    } else if (tx.to === currentUID) {
                        type = 'RECEIVED';
                        icon = '💰';
                        colorClass = 'text-green-600';
                        detailText = `<span class="font-mono text-xs text-gray-500 break-all">From: ${tx.from}</span>`;
                    } else {
                        type = 'OTHER';
                        icon = '🔗';
                        colorClass = 'text-gray-600';
                        detailText = `<span class="font-mono text-xs text-gray-500 break-all">Tx ID: ${txId}</span>`;
                    }

                    txListHTML += `
                        <li class="grid grid-cols-1 md:grid-cols-5 items-center text-sm py-2 border-b border-gray-100 last:border-b-0">
                            <span class="col-span-1 flex items-center font-bold ${colorClass}">${icon} ${type}</span>
                            <span class="col-span-3 text-xs md:text-sm text-gray-600 overflow-hidden truncate mt-1 md:mt-0">${detailText}</span>
                            <span class="col-span-1 text-right text-lg font-extrabold ${colorClass}">${amountDisplay}</span>
                        </li>
                    `;
                });

                blockEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3 border-b pb-2 border-gray-100">
                        <p class="text-base font-bold text-gray-800">Block #${blockHeight}</p>
                        <p class="text-xs font-semibold text-gray-500">${new Date(block.timestamp).toLocaleTimeString()} ${new Date(block.timestamp).toLocaleDateString()}</p>
                    </div>
                    <p class="font-mono text-xs text-gray-500 mb-3 break-all">Hash: ${block.hash}</p>
                    <ul class="divide-y divide-gray-100">${txListHTML}</ul>
                `;
                historyEl.appendChild(blockEl);
            });
        };


        // --- Initialization ---

        const initializeApp = async () => {
            // 1. Authentication
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(AUTH, initialAuthToken);
                } else {
                    await signInAnonymously(AUTH);
                }
            } catch (error) {
                console.error("Initial Auth Failed, falling back to listener:", error);
            }

            onAuthStateChanged(AUTH, async (user) => {
                if (user) {
                    currentUID = user.uid;
                    isAuthReady = true;
                    userUidEl.textContent = currentUID;
                    authStatusEl.textContent = `Wallet Active (UID: ${currentUID})`;
                    authStatusEl.classList.remove('text-red-500');
                    authStatusEl.classList.add('text-emerald-700');
                    
                    // Create or update user profile
                    const profileDocRef = doc(DB, PUBLIC_DATA_PATH, USER_PROFILES_COLLECTION, currentUID);
                    await setDoc(profileDocRef, {
                        uid: currentUID,
                        name: `User ${currentUID.substring(0, 4)}`,
                        lastSeen: Date.now()
                    }, { merge: true });

                    // 2. Start Listeners
                    startBlockchainListener();
                    startInvoicesListener(); // Depends on currentUID
                    startUserProfilesListener();
                } else {
                    currentUID = 'anonymous-user';
                    isAuthReady = false;
                    userUidEl.textContent = currentUID;
                    authStatusEl.textContent = 'Not authenticated. Please refresh if running in the Canvas environment.';
                }
            });

            // 3. Form Setup
            document.getElementById('mode-send').addEventListener('click', () => switchMode('send'));
            document.getElementById('mode-invoice').addEventListener('click', () => switchMode('invoice'));
            amountInput.addEventListener('input', updateSubmitButtonText);
            
            // Initial button setup
            switchMode('send');

            formEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!isAuthReady) {
                    showMessage("Error: Authentication not ready. Please wait.");
                    return;
                }
                const recipient = recipientInput.value.trim();
                const amount = parseFloat(amountInput.value);

                if (!recipient || isNaN(amount) || amount <= 0) {
                    showMessage("Error: Please enter a valid recipient ID and a positive amount.");
                    return;
                }

                if (currentMode === 'send') {
                    await handleSendTransaction(recipient, amount);
                } else {
                    await handleInvoiceRequest(recipient, amount);
                }
            });

            // 4. Utility Button Setup
            document.getElementById('copy-uid-btn').addEventListener('click', () => {
                const uid = userUidEl.textContent;
                if (uid && uid !== 'Loading...' && uid !== 'anonymous-user') {
                    // Use document.execCommand('copy') as navigator.clipboard might fail in some environments
                    const tempInput = document.createElement('textarea');
                    tempInput.value = uid;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand('copy');
                        showMessage('Wallet ID copied to clipboard!', 'success');
                    } catch (err) {
                        console.error('Copy error:', err);
                        showMessage('Could not copy text.', 'error');
                    }
                    document.body.removeChild(tempInput);
                } else {
                    showMessage('Cannot copy UID until authenticated.', 'error');
                }
            });
        };

        window.onload = initializeApp;
    </script>
</body>
</html>

<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitVen - Cryptocurrency Platform</title>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }
        
        .currency-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .currency-symbol {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .exchange-rate {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .wallet-section h2,
        .transfer-section h2,
        .history-section h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: white;
        }
        
        .balance-display {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .balance-naira {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }
        
        .user-info {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .transaction-amount {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .amount-positive {
            color: #4CAF50;
        }
        
        .amount-negative {
            color: #f44336;
        }
        
        .transaction-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .transaction-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .transaction-right {
            text-align: right;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-completed {
            background: #4CAF50;
            color: white;
        }
        
        .status-pending {
            background: #FF9800;
            color: white;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification-success {
            background: #4CAF50;
        }
        
        .notification-error {
            background: #f44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .hidden {
            display: none;
        }
        
        .google-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .google-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .currency-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .transaction-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .transaction-right {
                text-align: left;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Header -->
   <header class="header">
    <div class="card">
     <h1 id="platform-title">BitVen</h1>
     <p class="subtitle">By Forca Team</p>
     <div class="currency-info"><span id="currency-display" class="currency-symbol">BVN</span> <span style="color: rgba(255, 255, 255, 0.5);">â€¢</span> <span id="exchange-rate-display" class="exchange-rate">1 BVN = â‚¦1,000</span>
     </div>
    </div>
   </header><!-- Authentication Section -->
   <div id="auth-section" class="card">
    <h2 style="text-align: center; margin-bottom: 30px;">Welcome to BitVen</h2>
    <div style="text-align: center;"><button id="google-signin-btn" class="btn google-btn btn-full">
      <svg width="20" height="20" viewbox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /> <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /> <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /> <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
      </svg> Sign in with Google </button>
     <p style="margin-top: 20px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Secure authentication powered by Google</p>
    </div>
   </div><!-- Main App Section -->
   <div id="app-section" class="hidden"><!-- Admin Controls (Only visible to admin) -->
    <div id="admin-section" class="card hidden" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
     <h2 style="color: #ffc107;">ðŸ”§ Admin Controls</h2>
     <div class="grid" style="margin-bottom: 0;">
      <div>
       <div class="form-group"><label for="new-rate">Set New BVN Rate (â‚¦)</label> <input type="number" id="new-rate" class="form-control" placeholder="1000" min="1" step="0.01">
       </div><button id="update-rate-btn" class="btn btn-primary btn-full"> <span id="update-rate-text">Update Rate</span>
        <div id="update-rate-loading" class="loading-spinner hidden"></div></button>
      </div>
      <div>
       <h3 style="margin-bottom: 15px; color: #ffc107;">Current Rate</h3>
       <div style="text-align: center;">
        <div id="admin-current-rate" style="font-size: 2rem; font-weight: bold; color: #ffd700;">
         â‚¦1,000
        </div>
        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
         per BVN
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="grid"><!-- Wallet Section -->
     <div class="card">
      <h2>Your Wallet</h2>
      <div class="balance-display">
       <div id="balance-amount" class="balance-amount">
        0 BVN
       </div>
       <div id="balance-naira" class="balance-naira">
        â‚¦0
       </div>
       <div id="user-info" class="user-info">
        Wallet: Loading...
       </div>
      </div><button id="logout-btn" class="btn btn-danger btn-full"> Sign Out </button>
     </div><!-- Transfer Section -->
     <div class="card">
      <h2>Send BVN</h2>
      <form id="transfer-form">
       <div class="form-group"><label for="recipient-email">Recipient Email</label> <input type="email" id="recipient-email" class="form-control" placeholder="recipient@example.com" required>
       </div>
       <div class="form-group"><label for="transfer-amount">Amount (BVN)</label> <input type="number" id="transfer-amount" step="0.01" min="0.01" class="form-control" placeholder="0.00" required>
       </div><button type="submit" id="send-btn" class="btn btn-success btn-full"> <span id="send-btn-text">Send BVN</span>
        <div id="send-loading" class="loading-spinner hidden"></div></button>
      </form>
     </div>
    </div><!-- Price Chart -->
    <div class="card">
     <h2>BVN Price Chart</h2>
     <div id="price-chart-container">
      <canvas id="price-chart" width="800" height="300" style="max-width: 100%; height: auto;"></canvas>
     </div>
     <div style="margin-top: 20px; text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
      <h3 style="color: #ffc107; margin-bottom: 15px;">ðŸ’° Want to Buy or Sell BVN?</h3>
      <p style="margin-bottom: 15px; color: rgba(255, 255, 255, 0.9);">Contact our official trader for secure BVN transactions</p>
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;"><span style="font-weight: bold;">ðŸ“§ Vesni:</span> <a href="mailto:vesni277@gmail.com" style="color: #4CAF50; text-decoration: none; font-weight: bold;"> vesni277@gmail.com </a>
      </div>
      <p style="margin-top: 10px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Trusted â€¢ Secure â€¢ Fast Transactions</p>
     </div>
    </div><!-- Transaction History -->
    <div class="card">
     <h2>Transaction History</h2>
     <div id="transaction-list">
      <div class="empty-state">
       <p>Loading transactions...</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Firebase Configuration
       const firebaseConfig = {
  apiKey: "AIzaSyDWSebqVunmSzmw168fDZE_ePqoJ-_jsig",
  authDomain: "bitven-6d42c.firebaseapp.com",
  projectId: "bitven-6d42c",
  storageBucket: "bitven-6d42c.firebasestorage.app",
  messagingSenderId: "511584242303",
  appId: "1:511584242303:web:bdfeac7801c4d17b254d4a"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Configuration
        const defaultConfig = {
            platform_name: "BitVen",
            currency_symbol: "BVN",
            exchange_rate: "1000"
        };

        // Global state
        let currentUser = null;
        let userBalance = 0;
        let transactions = [];
        let isLoading = false;
        let priceHistory = [];
        let currentRate = 1000;

        // Admin and Banker accounts
        const BANKER_EMAIL = "lanushomeappliances@gmail.com";
        const ADMIN_EMAIL = "lanushomeappliances@gmail.com"; // Same as banker for now

        // Element SDK implementation
        const element = {
            defaultConfig,
            render: async (config) => {
                document.getElementById('platform-title').textContent = config.platform_name || defaultConfig.platform_name;
                document.getElementById('currency-display').textContent = config.currency_symbol || defaultConfig.currency_symbol;
                document.getElementById('exchange-rate-display').textContent = `1 ${config.currency_symbol || defaultConfig.currency_symbol} = â‚¦${config.exchange_rate || defaultConfig.exchange_rate}`;
                updateBalanceDisplay();
            },
            mapToCapabilities: (config) => ({
                recolorables: [
                    {
                        get: () => config.primary_color || "#667eea",
                        set: (value) => {
                            config.primary_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ["platform_name", config.platform_name || defaultConfig.platform_name],
                ["currency_symbol", config.currency_symbol || defaultConfig.currency_symbol],
                ["exchange_rate", config.exchange_rate || defaultConfig.exchange_rate]
            ])
        };

        // Initialize Element SDK
        async function initializeElementSDK() {
            try {
                if (window.elementSdk) {
                    await window.elementSdk.init(element);
                }
            } catch (error) {
                console.error("Failed to initialize Element SDK:", error);
            }
        }

        // Utility functions
        function generateTransactionId() {
            return 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(amount, symbol = 'BVN') {
            return `${amount.toFixed(2)} ${symbol}`;
        }

        function formatNaira(amount) {
            const config = window.elementSdk?.config || defaultConfig;
            const rate = parseFloat(config.exchange_rate || defaultConfig.exchange_rate);
            return `â‚¦${(amount * rate).toLocaleString()}`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function updateBalanceDisplay() {
            if (!currentUser) return;
            
            const config = window.elementSdk?.config || defaultConfig;
            const symbol = config.currency_symbol || defaultConfig.currency_symbol;
            
            document.getElementById('balance-amount').textContent = formatCurrency(userBalance, symbol);
            document.getElementById('balance-naira').textContent = formatNaira(userBalance);
        }

        // Chart functions
        function drawPriceChart() {
            const canvas = document.getElementById('price-chart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2; // For high DPI
            canvas.height = 300 * 2;
            ctx.scale(2, 2);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (priceHistory.length < 2) {
                // Draw placeholder
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Price history will appear here', canvas.width / 4, canvas.height / 4);
                return;
            }
            
            const padding = 40;
            const chartWidth = canvas.width / 2 - padding * 2;
            const chartHeight = canvas.height / 2 - padding * 2;
            
            // Find min and max prices
            const prices = priceHistory.map(p => p.rate);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice || 1;
            
            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // Draw price line
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            priceHistory.forEach((point, index) => {
                const x = padding + (chartWidth / (priceHistory.length - 1)) * index;
                const y = padding + chartHeight - ((point.rate - minPrice) / priceRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#4CAF50';
            priceHistory.forEach((point, index) => {
                const x = padding + (chartWidth / (priceHistory.length - 1)) * index;
                const y = padding + chartHeight - ((point.rate - minPrice) / priceRange) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            // Y-axis labels (prices)
            for (let i = 0; i <= 5; i++) {
                const price = minPrice + (priceRange / 5) * (5 - i);
                const y = padding + (chartHeight / 5) * i;
                ctx.fillText(`â‚¦${price.toFixed(0)}`, padding - 10, y + 4);
            }
            
            // Current price indicator
            const currentY = padding + chartHeight - ((currentRate - minPrice) / priceRange) * chartHeight;
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding, currentY);
            ctx.lineTo(padding + chartWidth, currentY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Current price label
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Current: â‚¦${currentRate}`, padding + 10, currentY - 10);
        }

        // Admin functions
        async function loadCurrentRate() {
            try {
                const rateDoc = await db.collection('settings').doc('exchange_rate').get();
                if (rateDoc.exists) {
                    currentRate = rateDoc.data().rate || 1000;
                } else {
                    // Initialize rate document
                    await db.collection('settings').doc('exchange_rate').set({
                        rate: 1000,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'system'
                    });
                }
                
                // Update displays
                document.getElementById('admin-current-rate').textContent = `â‚¦${currentRate.toLocaleString()}`;
                if (window.elementSdk) {
                    await window.elementSdk.setConfig({ exchange_rate: currentRate.toString() });
                }
            } catch (error) {
                console.error('Error loading current rate:', error);
            }
        }

        async function loadPriceHistory() {
            try {
                const historyRef = db.collection('price_history')
                    .orderBy('timestamp', 'desc')
                    .limit(30);
                
                const snapshot = await historyRef.get();
                priceHistory = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                })).reverse(); // Reverse to show chronological order
                
                drawPriceChart();
            } catch (error) {
                console.error('Error loading price history:', error);
            }
        }

        async function updateExchangeRate(newRate) {
            if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
                showNotification('Unauthorized: Admin access required', 'error');
                return false;
            }
            
            const updateBtn = document.getElementById('update-rate-text');
            const loadingSpinner = document.getElementById('update-rate-loading');
            
            updateBtn.textContent = 'Updating...';
            loadingSpinner.classList.remove('hidden');
            
            try {
                const rateData = {
                    rate: parseFloat(newRate),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                };
                
                // Update current rate
                await db.collection('settings').doc('exchange_rate').set(rateData);
                
                // Add to price history
                await db.collection('price_history').add({
                    rate: parseFloat(newRate),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                currentRate = parseFloat(newRate);
                
                // Update displays
                document.getElementById('admin-current-rate').textContent = `â‚¦${currentRate.toLocaleString()}`;
                document.getElementById('new-rate').value = '';
                
                // Update Element SDK config
                if (window.elementSdk) {
                    await window.elementSdk.setConfig({ exchange_rate: newRate.toString() });
                }
                
                // Reload price history and redraw chart
                await loadPriceHistory();
                updateBalanceDisplay();
                
                showNotification(`Exchange rate updated to â‚¦${currentRate.toLocaleString()} per BVN`);
                return true;
            } catch (error) {
                console.error('Error updating exchange rate:', error);
                showNotification('Failed to update exchange rate', 'error');
                return false;
            } finally {
                updateBtn.textContent = 'Update Rate';
                loadingSpinner.classList.add('hidden');
            }
        }

        // Firebase Auth functions
        function setupAuthStateListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    document.getElementById('user-info').textContent = `Wallet: ${user.email}`;
                    
                    // Show admin controls if user is admin
                    if (user.email === ADMIN_EMAIL) {
                        document.getElementById('admin-section').classList.remove('hidden');
                    } else {
                        document.getElementById('admin-section').classList.add('hidden');
                    }
                    
                    await initializeUserData();
                    await loadUserBalance();
                    await loadTransactions();
                    await loadCurrentRate();
                    await loadPriceHistory();
                    
                    showNotification(`Welcome back, ${user.email}!`);
                } else {
                    currentUser = null;
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('app-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.add('hidden');
                    userBalance = 0;
                    transactions = [];
                }
            });
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                showNotification('Sign in failed. Please try again.', 'error');
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                showNotification('Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed', 'error');
            }
        }

        // Firestore functions
        async function initializeUserData() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // Create new user document
                    await userRef.set({
                        email: currentUser.email,
                        balance: currentUser.email === BANKER_EMAIL ? 999999999 : 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update last active
                    await userRef.update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error initializing user data:', error);
            }
        }

        async function loadUserBalance() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    userBalance = userDoc.data().balance || 0;
                    updateBalanceDisplay();
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        async function loadTransactions() {
            if (!currentUser) return;
            
            try {
                const transactionsRef = db.collection('transactions')
                    .where('participants', 'array-contains', currentUser.email)
                    .orderBy('timestamp', 'desc')
                    .limit(50);
                
                const snapshot = await transactionsRef.get();
                transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateTransactionHistory();
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transaction-list').innerHTML = 
                    '<div class="empty-state"><p>Error loading transactions</p></div>';
            }
        }

        function updateTransactionHistory() {
            const transactionList = document.getElementById('transaction-list');
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-state"><p>No transactions yet</p></div>';
                return;
            }

            const config = window.elementSdk?.config || defaultConfig;
            const symbol = config.currency_symbol || defaultConfig.currency_symbol;

            transactionList.innerHTML = transactions.map(tx => {
                const isReceived = tx.to_email === currentUser.email;
                const otherParty = isReceived ? tx.from_email : tx.to_email;
                const date = tx.timestamp ? new Date(tx.timestamp.toDate()).toLocaleString() : 'Unknown';
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div>
                                <div class="transaction-amount ${isReceived ? 'amount-positive' : 'amount-negative'}">
                                    ${isReceived ? '+' : '-'}${formatCurrency(tx.amount, symbol)}
                                </div>
                                <div class="transaction-details">
                                    ${isReceived ? 'From' : 'To'}: ${otherParty}
                                </div>
                                <div class="transaction-date">${date}</div>
                            </div>
                            <div class="transaction-right">
                                <div class="status-badge status-${tx.status}">
                                    ${tx.status}
                                </div>
                                <div style="margin-top: 5px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                    ${formatNaira(tx.amount)}
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">
                                    ID: ${tx.transaction_id.slice(-8)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function createTransaction(toEmail, amount) {
            if (isLoading || !currentUser) return false;
            
            isLoading = true;
            const sendBtn = document.getElementById('send-btn-text');
            const loadingSpinner = document.getElementById('send-loading');
            
            sendBtn.textContent = 'Processing...';
            loadingSpinner.classList.remove('hidden');

            try {
                // Check if recipient exists, if not create them
                const recipientQuery = await db.collection('users').where('email', '==', toEmail).get();
                let recipientId = null;
                
                if (recipientQuery.empty) {
                    // Create new user for recipient
                    const newUserRef = db.collection('users').doc();
                    await newUserRef.set({
                        email: toEmail,
                        balance: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    recipientId = newUserRef.id;
                } else {
                    recipientId = recipientQuery.docs[0].id;
                }

                const transaction = {
                    transaction_id: generateTransactionId(),
                    from_email: currentUser.email,
                    to_email: toEmail,
                    amount: parseFloat(amount),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed',
                    type: 'transfer',
                    participants: [currentUser.email, toEmail]
                };

                // Use Firestore transaction to ensure consistency
                await db.runTransaction(async (firestoreTransaction) => {
                    const senderRef = db.collection('users').doc(currentUser.uid);
                    const recipientRef = db.collection('users').doc(recipientId);
                    
                    const senderDoc = await firestoreTransaction.get(senderRef);
                    const recipientDoc = await firestoreTransaction.get(recipientRef);
                    
                    const senderBalance = senderDoc.data().balance || 0;
                    const recipientBalance = recipientDoc.data().balance || 0;
                    
                    // Check balance (except for banker)
                    if (currentUser.email !== BANKER_EMAIL && senderBalance < parseFloat(amount)) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Update balances
                    const newSenderBalance = currentUser.email === BANKER_EMAIL ? 
                        senderBalance : senderBalance - parseFloat(amount);
                    const newRecipientBalance = recipientBalance + parseFloat(amount);
                    
                    firestoreTransaction.update(senderRef, { balance: newSenderBalance });
                    firestoreTransaction.update(recipientRef, { balance: newRecipientBalance });
                    
                    // Create transaction record
                    const transactionRef = db.collection('transactions').doc();
                    firestoreTransaction.set(transactionRef, transaction);
                });

                // Update local balance and reload data
                await loadUserBalance();
                await loadTransactions();
                
                showNotification(`Successfully sent ${formatCurrency(amount, 'BVN')} to ${toEmail}!`);
                document.getElementById('transfer-form').reset();
                
                return true;
            } catch (error) {
                console.error('Transaction error:', error);
                showNotification(error.message || 'Transaction failed. Please try again.', 'error');
                return false;
            } finally {
                isLoading = false;
                sendBtn.textContent = 'Send BVN';
                loadingSpinner.classList.add('hidden');
            }
        }

        // Event listeners
        document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
        document.getElementById('logout-btn').addEventListener('click', signOut);

        // Admin event listeners
        document.getElementById('update-rate-btn').addEventListener('click', async function() {
            const newRate = document.getElementById('new-rate').value;
            
            if (!newRate || parseFloat(newRate) <= 0) {
                showNotification('Please enter a valid rate', 'error');
                return;
            }
            
            await updateExchangeRate(newRate);
        });

        document.getElementById('transfer-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recipientEmail = document.getElementById('recipient-email').value.trim();
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            
            if (!recipientEmail || !recipientEmail.includes('@')) {
                showNotification('Please enter a valid recipient email.', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount.', 'error');
                return;
            }
            
            if (recipientEmail === currentUser.email) {
                showNotification('You cannot send BVN to yourself.', 'error');
                return;
            }
            
            if (currentUser.email !== BANKER_EMAIL && amount > userBalance) {
                showNotification('Insufficient balance.', 'error');
                return;
            }
            
            await createTransaction(recipientEmail, amount);
        });

        // Initialize app
        setupAuthStateListener();
        initializeElementSDK();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fa2017c1e13302',t:'MTc2MDY0NDY0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

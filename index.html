<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen-Forca</title>
    <!-- Custom Pure CSS for Clean, Modern Look -->
    <style>
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --background-color: #f8f9fa; /* Light Gray */
            --card-background: #ffffff; /* White */
            --text-color: #343a40; /* Dark Gray */
            --success-color: #28a745; /* Green */
            --danger-color: #dc3545; /* Red */
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .container {
                grid-template-columns: 2fr 1fr; /* Main content and sidebar */
            }
        }

        /* Card Styling */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        /* Buttons and Inputs */
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group textarea {
            width: 95%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        /* Utility */
        .wallet-info, .balance-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dotted #e9ecef;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: bold;
            color: var(--success-color);
        }

        .admin-mode {
            color: var(--danger-color);
        }

        .tx-list {
            list-style: none;
            padding: 0;
        }

        .tx-item {
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            background-color: #f0f3f6;
        }

        .tx-item strong {
            display: inline-block;
            min-width: 80px;
        }

        .log-error {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .directory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .directory-item:last-child {
            border-bottom: none;
        }

        .invoice-card {
            border: 1px dashed var(--primary-color);
            background-color: #e0f0ff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
        }

        .invoice-card button {
            background-color: var(--success-color);
            color: white;
            padding: 5px 10px;
            margin-left: 10px;
        }

        .invoice-card button:hover {
            background-color: #1e7e34;
        }
        .code-block {
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="main-content">
        <div class="card">
            <h2 class="card-header">BitVen Wallet</h2>

            <div class="wallet-info">
                <span>Status:</span>
                <span id="auth-status" style="font-weight: bold; color: var(--danger-color);">Loading...</span>
            </div>
            
            <div class="wallet-info">
                <span>Wallet ID (UID):</span>
                <span id="current-wallet-id" class="code-block">Awaiting Sign-in...</span>
                <button class="btn btn-secondary" onclick="window.copyWalletId()">Copy ID</button>
            </div>
            <div class="wallet-info balance-display">
                <span>Current Balance:</span>
                <span id="current-balance" class="balance-amount">0.00 BVN</span>
            </div>

            <button class="btn btn-primary" id="sign-in-btn" onclick="window.signInWithGoogle()" style="width: 100%;">
                Sign In / Switch Account
            </button>
        </div>

        <!-- Transaction Card -->
        <div class="card" id="transaction-card" style="display: none;">
            <h2 class="card-header" id="transaction-header">Send BitVen</h2>

            <!-- Toggle Button for Send/Request -->
            <button class="btn btn-secondary" id="toggle-request-mode-btn" onclick="window.toggleRequestMode()">
                Switch to Invoice Request
            </button>

            <!-- Send Form -->
            <div id="send-form">
                <div class="input-group">
                    <label for="recipient-address">Recipient Address (UID):</label>
                    <input type="text" id="recipient-address" placeholder="Enter recipient UID or select from directory" required>
                </div>
                <div class="input-group">
                    <label for="send-amount">Amount (BVN):</label>
                    <input type="number" id="send-amount" min="0.01" step="0.01" value="1.00" required>
                </div>
                <div class="input-group">
                    <label for="send-message">Message (Optional):</label>
                    <textarea id="send-message" placeholder="Payment for service, loan repayment, etc."></textarea>
                </div>
                <button class="btn btn-primary" onclick="window.sendTransaction()">Send BitVen</button>
                <p style="margin-top: 10px; font-size: 0.9em;">Transaction Fee: 0.01 BVN (Burned)</p>
            </div>

            <!-- Request Form -->
            <div id="request-form" style="display: none;">
                <div class="input-group">
                    <label for="debtor-address">Debtor Address (UID):</label>
                    <input type="text" id="debtor-address" placeholder="UID of the person who owes you" required>
                </div>
                <div class="input-group">
                    <label for="request-amount">Amount Requested (BVN):</label>
                    <input type="number" id="request-amount" min="0.01" step="0.01" value="10.00" required>
                </div>
                <div class="input-group">
                    <label for="request-message">Reason for Request:</label>
                    <textarea id="request-message" placeholder="Invoice for work done, shared dinner cost, etc." required></textarea>
                </div>
                <button class="btn btn-primary" onclick="window.requestFunds()">Create Invoice Request</button>
            </div>
        </div>

        <!-- Pending Invoices -->
        <div class="card" id="invoices-card" style="display: none;">
            <h2 class="card-header">Pending Invoices Sent To You</h2>
            <div id="invoices-list">
                <p>No pending invoices.</p>
            </div>
        </div>

        <!-- Blockchain Ledger -->
        <div class="card">
            <h2 class="card-header">Blockchain Ledger</h2>
            <div id="chain-validation-status">Validating...</div>
            <div id="blockchain-list">
                <!-- Blocks will be injected here -->
                <p>Loading blockchain...</p>
            </div>
        </div>
    </div>

    <!-- Sidebar Content -->
    <div id="sidebar-content">
        <!-- User Directory -->
        <div class="card">
            <h2 class="card-header">Live User Directory</h2>
            <div id="user-directory">
                <p>Loading user list...</p>
            </div>
        </div>

        <!-- Personal Transaction History -->
        <div class="card">
            <h2 class="card-header">Your Recent Activity</h2>
            <div id="personal-history">
                <p>No transactions yet.</p>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="card" id="debug-log-card" style="display: none;">
            <h2 class="card-header">Debug Log</h2>
            <div id="debug-log" style="font-size: 0.8em; max-height: 200px; overflow-y: scroll; white-space: pre-wrap;"></div>
        </div>
    </div>
</div>

<script type="module">
    // --- 1. Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, writeBatch, serverTimestamp, setLogLevel, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 2. Configuration & Constants ---
    const ADMIN_EMAIL = "lanushomeappliances@gmail.com";
    const BURN_ADDRESS = "0xBURN-BVN-SUPPLY";
    const TX_FEE = 0.01;
    const BVN_TO_NGN_RATE = 1000; // 1 BVN = 1,000 NGN

    // Firebase Global Variables (Provided by environment, must be checked)
    const firebaseConfig = { 
        apiKey: "AIzaSyDWSebqVunmSzmw168fDZE_ePqoJ-_jsig", 
        authDomain: "bitven-6d42c.firebaseapp.com", 
        projectId: "bitven-6d42c", 
        storageBucket: "bitven-6d42c.firebasestorage.app", 
        messagingSenderId: "511584242303", 
        appId: "1:511584242303:web:bdfeac7801c4d17b254d4a" 
    };

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Global Instances and State
    let app = null;
    let auth = null;
    let db = null;
    let currentUID = null;
    let currentUserEmail = null;
    let isAdmin = false;

    // Database References (Will be set after DB init)
    let CHAIN_REF;
    let INVOICE_REF;
    let USER_PROFILES_REF;

    // Local Data Cache
    let blocksData = [];
    let pendingInvoicesData = [];
    let userProfiles = [];
    let currentBalance = 0;
    
    // --- 3. Logging Utility ---
    const log = (message, isError = false) => {
        const logElement = document.getElementById('debug-log');
        const timestamp = new Date().toLocaleTimeString();
        const output = `[${timestamp}] ${isError ? 'ERROR: ' : ''}${message}\n`;
        if (logElement) {
            logElement.textContent = output + logElement.textContent;
        }
        if (isError) {
            console.error(message);
        } else {
            console.log(message);
        }
    };

    // --- 4. Data Structures (Classes for clarity, serialized before Firestore) ---

    // Class to represent a transaction (payment or reward)
    class Transaction {
        constructor(fromAddress, toAddress, amount, message = '', isReward = false, isFee = false, isRequest = false) {
            this.fromAddress = fromAddress;
            this.toAddress = toAddress;
            this.amount = parseFloat(amount);
            this.message = message || (isReward ? "Mining Reward" : (isFee ? "Transaction Fee (Burn)" : "Payment"));
            this.isReward = isReward;
            this.isFee = isFee;
            this.isRequest = isRequest;
            this.timestamp = Date.now();
        }

        // Converts class instance to a plain JavaScript object for Firestore
        toPlainObject() {
            return {
                fromAddress: this.fromAddress,
                toAddress: this.toAddress,
                amount: this.amount,
                message: this.message,
                isReward: this.isReward,
                isFee: this.isFee,
                isRequest: this.isRequest,
                timestamp: this.timestamp
            };
        }
    }

    // Class to represent a Block in the chain
    class Block {
        constructor(index, transactions, previousHash = '') {
            this.index = index;
            this.timestamp = Date.now();
            this.transactions = transactions;
            this.previousHash = previousHash;
            this.hash = this.calculateHash();
        }

        calculateHash() {
            const dataString = this.index + this.timestamp + JSON.stringify(this.transactions.map(tx => tx.toPlainObject())) + this.previousHash;
            let hash = 0;
            for (let i = 0; i < dataString.length; i++) {
                hash = (hash << 5) - hash + dataString.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(36);
        }

        // Converts block (and its transactions) to a plain JavaScript object for Firestore
        toPlainObject() {
            return {
                index: this.index,
                timestamp: this.timestamp,
                transactions: this.transactions.map(tx => tx.toPlainObject()),
                previousHash: this.previousHash,
                hash: this.hash
            };
        }
    }

    // --- 5. Firebase Initialization and Authentication ---

    const setupListeners = () => {
        if (!db) {
            log("Firestore not initialized. Cannot set up listeners.", true);
            return;
        }
        
        // 1. Blockchain Listener (Reads the Chain and calculates Balance)
        onSnapshot(query(CHAIN_REF, orderBy('index', 'desc')), (snapshot) => {
            log("Blockchain snapshot received.");
            blocksData = snapshot.docs.map(doc => {
                const data = doc.data();
                // Deserialize transactions back into class instances for correct balance calculation
                data.transactions = data.transactions.map(tx => Object.assign(new Transaction(), tx));
                return Object.assign(new Block(), data);
            });
            
            blocksData.sort((a, b) => a.index - b.index); // Ensure ascending order
            window.calculateAndDisplayBalance();
            window.renderBlockchain();
        });

        // 2. Pending Invoices Listener (Requests sent TO the current user)
        onSnapshot(query(INVOICE_REF), (snapshot) => {
            log("Invoices snapshot received.");
            pendingInvoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.renderInvoices();
        });

        // 3. User Directory Listener
        onSnapshot(query(USER_PROFILES_REF), (snapshot) => {
            log("User profiles snapshot received.");
            userProfiles = snapshot.docs.map(doc => doc.data());
            window.renderUserDirectory();
        });
    };

    const handleAuthChange = (user) => {
        if (user) {
            currentUID = user.uid;
            currentUserEmail = user.email || "N/A";
            
            // Check for Admin status based on email
            isAdmin = currentUserEmail === ADMIN_EMAIL;

            log(`User signed in. UID: ${currentUID}, Email: ${currentUserEmail}, Admin: ${isAdmin}`);

            // Update UI elements
            document.getElementById('auth-status').textContent = isAdmin ? 'ADMIN' : 'Authenticated';
            document.getElementById('auth-status').style.color = isAdmin ? 'var(--danger-color)' : 'var(--success-color)';
            document.getElementById('current-wallet-id').textContent = currentUID;
            document.getElementById('transaction-card').style.display = 'block';
            document.getElementById('invoices-card').style.display = 'block';
            document.getElementById('sign-in-btn').textContent = 'Sign Out / Switch Account';

            // Save user profile to public directory
            setDoc(doc(USER_PROFILES_REF, currentUID), {
                uid: currentUID,
                email: currentUserEmail,
                lastSeen: serverTimestamp(),
            }, { merge: true }).catch(e => log(`Failed to save profile: ${e.message}`, true));

            // Setup real-time listeners only after successful authentication
            setupListeners();
            window.calculateAndDisplayBalance();

        } else {
            log("User signed out.");
            currentUID = null;
            currentUserEmail = null;
            isAdmin = false;
            
            // Reset UI
            document.getElementById('auth-status').textContent = 'Signed Out';
            document.getElementById('auth-status').style.color = 'var(--secondary-color)';
            document.getElementById('current-wallet-id').textContent = 'Awaiting Sign-in...';
            document.getElementById('current-balance').textContent = '0.00 BVN';
            document.getElementById('transaction-card').style.display = 'none';
            document.getElementById('invoices-card').style.display = 'none';
            document.getElementById('sign-in-btn').textContent = 'Sign In with Google';
        }
    };

    const initializeBitVen = () => {
        if (!firebaseConfig.apiKey) {
            log("FATAL ERROR: Firebase config is missing or invalid. Application will not connect to Firestore.", true);
            document.getElementById('auth-status').textContent = 'CONFIG ERROR';
            return;
        }

        try {
            // 1. Initialize App and Services
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug'); // Enable debug logging for Firestore

            // 2. Set Database References
            const publicPath = `artifacts/${appId}/public/data`;
            CHAIN_REF = collection(db, `${publicPath}/blockchain_chain_v2`);
            INVOICE_REF = collection(db, `${publicPath}/invoices_v2`);
            USER_PROFILES_REF = collection(db, `${publicPath}/user_profiles_v2`);

            log("Firebase App initialized. Debug logging enabled.");
            log("Attempting authentication...");

            // 3. Start Authentication Listener
            onAuthStateChanged(auth, (user) => {
                // If a user is signed in (either from initial token or later Google sign-in)
                if (user) {
                    handleAuthChange(user);
                } else {
                    // If no user is signed in (e.g., after initial token expired or manually signed out)
                    handleAuthChange(null);
                }
            });
            
            // 4. Attempt initial sign-in using environment token
            if (initialAuthToken) {
                log("Custom token available. Attempting sign-in...");
                signInWithCustomToken(auth, initialAuthToken)
                    .then(userCredential => log(`Signed in with custom token. UID: ${userCredential.user.uid}`))
                    .catch(e => log(`Custom Token Error: ${e.message}. User must use Sign In button.`, true));
            } else {
                log("No initial auth token provided. User must manually sign in via Google.");
            }

        } catch (e) {
            log(`FATAL ERROR during Initialization: ${e.message}`, true);
        }
    };


    // --- 6. Global Functions (Called by HTML) ---

    window.signInWithGoogle = async () => {
        if (!auth) {
            log("Firebase Auth not initialized. Cannot sign in.", true);
            return;
        }

        if (currentUID) {
            // User is already signed in, so treat this as a sign-out/switch request
            await signOut(auth);
            return;
        }

        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' }); // Forces account selection

        try {
            const result = await signInWithPopup(auth, provider);
            // The handleAuthChange listener will fire automatically upon success
            log(`Successfully signed in with Google. User: ${result.user.email}`);
        } catch (error) {
            log(`Google Sign-In Error: ${error.message}`, true);
        }
    };

    window.copyWalletId = () => {
        const id = document.getElementById('current-wallet-id').textContent;
        if (id && id !== 'Awaiting Sign-in...') {
            // Use document.execCommand('copy') for better compatibility in iframes
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = id;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert("Wallet ID copied to clipboard!"); // Replaced with alert for now
        }
    };
    
    // --- 7. Core Ledger Logic ---

    // Function to ensure all objects are converted to plain objects for saving
    const serializeBlock = (block) => {
        return {
            index: block.index,
            timestamp: block.timestamp,
            previousHash: block.previousHash,
            hash: block.hash,
            transactions: block.transactions.map(tx => tx.toPlainObject()),
        };
    };

    const addBlockToChain = async (transactions) => {
        if (!db || !currentUID) return log("Database or user not ready.", true);

        // 1. Get the last block to set the previousHash
        const lastBlock = blocksData.length > 0 ? blocksData[blocksData.length - 1] : null;
        const previousHash = lastBlock ? lastBlock.hash : '0'; // Genesis block hash is '0'
        const newIndex = lastBlock ? lastBlock.index + 1 : 1;

        // 2. Create the new Block object
        const newBlock = new Block(newIndex, transactions, previousHash);

        // 3. Prepare batch write for atomicity (Block + Deleting Invoice if applicable)
        const batch = writeBatch(db);
        const blockRef = doc(CHAIN_REF, newBlock.hash); // Use hash as doc ID for integrity check
        
        // 4. Save the new Block (MUST serialize the data)
        batch.set(blockRef, serializeBlock(newBlock));
        
        // 5. Commit the batch write
        try {
            await batch.commit();
            log(`Block #${newIndex} created successfully. Hash: ${newBlock.hash}`);
            return true;
        } catch (e) {
            log(`Failed to commit block: ${e.message}`, true);
            alert(`Transaction failed: ${e.message}`);
            return false;
        }
    };

    const validateTransactionInput = (recipient, amount) => {
        if (!currentUID) {
            alert("Please sign in first.");
            return false;
        }
        if (recipient === currentUID) {
            alert("Cannot send funds to yourself.");
            return false;
        }
        if (recipient === BURN_ADDRESS && !confirm("Are you sure you want to burn (permanently destroy) this BVN?")) {
            return false;
        }
        if (amount <= 0) {
            alert("Amount must be positive.");
            return false;
        }

        // Only check balance if the user is NOT the admin
        if (!isAdmin) {
            const totalCost = amount + TX_FEE;
            if (totalCost > currentBalance) {
                alert(`Insufficient funds. You need ${totalCost.toFixed(2)} BVN (incl. fee). Your balance is ${currentBalance.toFixed(2)} BVN.`);
                return false;
            }
        }
        return true;
    };

    window.sendTransaction = async () => {
        const recipientAddress = document.getElementById('recipient-address').value.trim();
        const sendAmount = parseFloat(document.getElementById('send-amount').value);
        const sendMsg = document.getElementById('send-message').value.trim();

        if (!validateTransactionInput(recipientAddress, sendAmount)) return;

        log(`Initiating instant payment: ${sendAmount} BVN from ${currentUID} to ${recipientAddress}`);
        
        const transactions = [];

        // 1. Main Payment Transaction
        transactions.push(new Transaction(currentUID, recipientAddress, sendAmount, sendMsg));

        // 2. Transaction Fee (Skipped for admin)
        if (!isAdmin) {
            transactions.push(new Transaction(currentUID, BURN_ADDRESS, TX_FEE, "Network Fee", false, true));
        }

        // 3. Clear pending invoice if this payment corresponds to one
        const invoicePaid = pendingInvoicesData.find(inv => 
            inv.fromAddress === recipientAddress && inv.toAddress === currentUID && inv.amount === sendAmount
        );
        
        if (invoicePaid) {
            log(`Detected and paying invoice ID: ${invoicePaid.id}`);
            // Note: We don't delete the invoice here. We rely on the user to manually remove it 
            // OR use a separate process to clean up old invoices, keeping logic simple.
        }

        // 4. Add the block instantly (Bypassing mining pool)
        await addBlockToChain(transactions);
        
        // Clear inputs
        document.getElementById('recipient-address').value = '';
        document.getElementById('send-amount').value = '1.00';
        document.getElementById('send-message').value = '';
    };

    window.requestFunds = async () => {
        const debtorAddress = document.getElementById('debtor-address').value.trim();
        const requestAmount = parseFloat(document.getElementById('request-amount').value);
        const requestMsg = document.getElementById('request-message').value.trim();

        if (!currentUID) {
            return alert("Please sign in first.");
        }
        if (debtorAddress === currentUID) {
            return alert("Cannot request funds from yourself.");
        }
        if (requestAmount <= 0) {
            return alert("Amount must be positive.");
        }
        if (!requestMsg) {
            return alert("Please provide a reason for the request (message).");
        }

        try {
            // Invoices are stored as pending transactions in the INVOICE_REF
            const requestTx = new Transaction(
                debtorAddress,  // The debtor is the 'fromAddress'
                currentUID,     // The requester (current user) is the 'toAddress'
                requestAmount,
                requestMsg,
                false,
                false,
                true // Flag as a request
            );

            await setDoc(doc(INVOICE_REF), requestTx.toPlainObject());
            log(`Invoice request sent to ${debtorAddress} for ${requestAmount} BVN.`);
            alert(`Invoice for ${requestAmount} BVN created successfully and sent to ${debtorAddress}!`);

            // Clear inputs
            document.getElementById('debtor-address').value = '';
            document.getElementById('request-amount').value = '10.00';
            document.getElementById('request-message').value = '';
        } catch (e) {
            log(`Failed to create invoice: ${e.message}`, true);
            alert(`Failed to create invoice: ${e.message}`);
        }
    };

    // --- 8. Display & UI Functions ---
    
    window.calculateAndDisplayBalance = () => {
        let balance = 0;
        const currentUID = auth.currentUser?.uid;
        
        if (!currentUID) {
            currentBalance = 0;
            document.getElementById('current-balance').textContent = '0.00 BVN';
            return;
        }

        // Admin check: If the user is the admin, they have infinite funds and pay no fees.
        if (isAdmin) {
            currentBalance = Infinity;
            document.getElementById('current-balance').innerHTML = '<span class="balance-amount admin-mode" style="color: var(--danger-color); font-size: 1.5rem;">&infin; BVN (ADMIN MODE)</span>';
            return;
        }
        
        blocksData.forEach(block => {
            block.transactions.forEach(tx => {
                if (tx.toAddress === currentUID) {
                    balance += tx.amount; // Received
                } else if (tx.fromAddress === currentUID) {
                    balance -= tx.amount; // Sent (includes fees)
                }
            });
        });

        currentBalance = balance;
        const ngnValue = (currentBalance * BVN_TO_NGN_RATE).toLocaleString('en-NG', { style: 'currency', currency: 'NGN' });

        document.getElementById('current-balance').innerHTML = 
            `${balance.toFixed(2)} BVN <span style="font-size: 0.6em; color: var(--secondary-color);">(${ngnValue})</span>`;
    };

    window.renderBlockchain = () => {
        const list = document.getElementById('blockchain-list');
        list.innerHTML = '';
        const currentUID = auth.currentUser?.uid || 'N/A';
        
        if (blocksData.length === 0) {
            list.innerHTML = '<p>Blockchain is empty (Genesis Block missing).</p>';
            return;
        }

        // Validate chain integrity (optional check)
        let isChainValid = true;
        for (let i = 1; i < blocksData.length; i++) {
            const currentBlock = blocksData[i];
            const previousBlock = blocksData[i - 1];

            if (currentBlock.previousHash !== previousBlock.hash) {
                isChainValid = false;
                break;
            }
        }
        document.getElementById('chain-validation-status').innerHTML = isChainValid 
            ? `<span style="color: var(--success-color); font-weight: bold;">Chain is Valid (Total Blocks: ${blocksData.length})</span>`
            : `<span style="color: var(--danger-color); font-weight: bold;">CHAIN IS BROKEN!</span>`;


        blocksData.slice().reverse().forEach(block => {
            const blockEl = document.createElement('div');
            blockEl.className = 'tx-item';
            
            const transactionsHtml = block.transactions.map(tx => {
                let statusColor = 'var(--text-color)';
                if (tx.isFee) statusColor = 'var(--secondary-color)';
                else if (tx.toAddress === currentUID) statusColor = 'var(--success-color)';
                else if (tx.fromAddress === currentUID) statusColor = 'var(--danger-color)';

                const amountText = `${tx.amount.toFixed(2)} BVN`;
                const ngnValue = (tx.amount * BVN_TO_NGN_RATE).toLocaleString('en-NG', { maximumFractionDigits: 0 });
                const valueDisplay = `(${ngnValue})`;

                let direction = 'TX';
                if (tx.isFee) direction = 'FEE';
                else if (tx.toAddress === currentUID) direction = 'IN';
                else if (tx.fromAddress === currentUID) direction = 'OUT';


                return `
                    <p style="color: ${statusColor}; font-size: 0.9em; margin: 5px 0;">
                        [${direction}] <strong>${amountText}</strong> ${valueDisplay}<br>
                        &rarr; From: ${tx.fromAddress === currentUID ? 'YOU' : tx.fromAddress.substring(0, 8)}...<br>
                        &rarr; To: ${tx.toAddress === currentUID ? 'YOU' : tx.toAddress.substring(0, 8)}...<br>
                        <span style="font-style: italic;">"${tx.message.substring(0, 50)}${tx.message.length > 50 ? '...' : ''}"</span>
                    </p>`;
            }).join('<hr style="border-top: 1px dashed #ccc; margin: 5px 0;">');

            blockEl.innerHTML = `
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">BLOCK #${block.index}</div>
                <p><strong>Hash:</strong> <span class="code-block" style="font-size: 0.75em;">${block.hash.substring(0, 20)}...</span></p>
                <p><strong>Previous:</strong> <span class="code-block" style="font-size: 0.75em;">${block.previousHash.substring(0, 20)}...</span></p>
                <p style="font-size: 0.8em; color: var(--secondary-color);">Mined: ${new Date(block.timestamp).toLocaleString()}</p>
                <details>
                    <summary style="cursor: pointer; color: var(--primary-color);">View Transactions (${block.transactions.length})</summary>
                    <div style="margin-top: 10px; padding-left: 10px;">${transactionsHtml}</div>
                </details>
            `;
            list.appendChild(blockEl);
        });
        window.renderPersonalHistory(); // Update personal history after chain render
    };

    window.renderUserDirectory = () => {
        const directory = document.getElementById('user-directory');
        directory.innerHTML = '';
        
        if (userProfiles.length === 0) {
            directory.innerHTML = '<p>No other users online yet.</p>';
            return;
        }

        userProfiles.forEach(profile => {
            if (profile.uid === currentUID) return; // Don't list self

            const profileEl = document.createElement('div');
            profileEl.className = 'directory-item';
            profileEl.innerHTML = `
                <div>
                    <strong>${profile.email || 'Anonymous'}</strong>
                    <div style="font-size: 0.8em; color: var(--secondary-color);">ID: ${profile.uid.substring(0, 12)}...</div>
                </div>
                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;" onclick="document.getElementById('recipient-address').value='${profile.uid}'; document.getElementById('debtor-address').value='${profile.uid}';">
                    Use ID
                </button>
            `;
            directory.appendChild(profileEl);
        });
    };
    
    window.renderInvoices = () => {
        const list = document.getElementById('invoices-list');
        list.innerHTML = '';
        const currentUID = auth.currentUser?.uid || 'N/A';
        let found = false;

        pendingInvoicesData.forEach(invoice => {
            // Only show invoices where the current user is the debtor (fromAddress)
            if (invoice.fromAddress === currentUID) {
                found = true;
                const ngnValue = (invoice.amount * BVN_TO_NGN_RATE).toLocaleString('en-NG', { maximumFractionDigits: 0 });
                
                const invoiceEl = document.createElement('div');
                invoiceEl.className = 'invoice-card';
                invoiceEl.innerHTML = `
                    <p><strong>Invoice From:</strong> ${invoice.toAddress.substring(0, 12)}...</p>
                    <p><strong>Amount Due:</strong> ${invoice.amount.toFixed(2)} BVN (${ngnValue})</p>
                    <p style="font-style: italic; font-size: 0.9em; color: var(--secondary-color);">"${invoice.message}"</p>
                    <button class="btn btn-primary" onclick="window.payInvoice('${invoice.toAddress}', ${invoice.amount}, '${invoice.id}')">
                        Pay Now
                    </button>
                `;
                list.appendChild(invoiceEl);
            }
        });

        if (!found) {
            list.innerHTML = '<p>No pending invoices for you.</p>';
        }
    };
    
    window.payInvoice = (recipientUID, amount, invoiceId) => {
        document.getElementById('recipient-address').value = recipientUID;
        document.getElementById('send-amount').value = amount.toFixed(2);
        document.getElementById('send-message').value = `Payment for Invoice ID: ${invoiceId}`;
        document.getElementById('transaction-header').textContent = 'Send BitVen (Paying Invoice)';
        document.getElementById('toggle-request-mode-btn').textContent = 'Switch to Invoice Request';
        document.getElementById('send-form').style.display = 'block';
        document.getElementById('request-form').style.display = 'none';
        
        alert(`Payment details loaded for Invoice ${invoiceId}! Please review and click "Send BitVen".`);
    };

    window.renderPersonalHistory = () => {
        const historyEl = document.getElementById('personal-history');
        historyEl.innerHTML = '';
        const currentUID = auth.currentUser?.uid || 'N/A';

        if (!currentUID || blocksData.length === 0) {
            historyEl.innerHTML = '<p>Sign in to view history.</p>';
            return;
        }

        const allTransactions = [];

        // 1. Transactions from Blockchain
        blocksData.forEach(block => {
            block.transactions.forEach(tx => {
                if (tx.fromAddress === currentUID || tx.toAddress === currentUID) {
                    allTransactions.push({ ...tx, type: 'CLEARED' });
                }
            });
        });

        // 2. Pending Invoices SENT TO YOU
        pendingInvoicesData.forEach(invoice => {
            if (invoice.fromAddress === currentUID) { // Current user is the debtor
                allTransactions.push({ ...invoice, type: 'INVOICE_DUE' });
            } else if (invoice.toAddress === currentUID) { // Current user is the creditor
                 allTransactions.push({ ...invoice, type: 'INVOICE_SENT' });
            }
        });


        // Sort all activity by timestamp (most recent first)
        allTransactions.sort((a, b) => b.timestamp - a.timestamp);

        if (allTransactions.length === 0) {
            historyEl.innerHTML = '<p>No activity yet.</p>';
            return;
        }

        allTransactions.slice(0, 20).forEach(item => { // Show top 20 events
            const historyItem = document.createElement('div');
            historyItem.className = 'tx-item';

            let statusColor = 'var(--text-color)';
            let directionText = '';

            if (item.type === 'CLEARED') {
                if (item.isFee) {
                    statusColor = 'var(--secondary-color)';
                    directionText = `FEE: ${item.amount.toFixed(2)} BVN (Burned)`;
                } else if (item.fromAddress === currentUID) {
                    statusColor = 'var(--danger-color)';
                    directionText = `SENT: -${item.amount.toFixed(2)} BVN to ${item.toAddress.substring(0, 8)}...`;
                } else {
                    statusColor = 'var(--success-color)';
                    directionText = `RECEIVED: +${item.amount.toFixed(2)} BVN from ${item.fromAddress.substring(0, 8)}...`;
                }
            } else if (item.type === 'INVOICE_DUE') {
                statusColor = '#ffc107'; // Yellow/Warning
                directionText = `INVOICE DUE: ${item.amount.toFixed(2)} BVN to ${item.toAddress.substring(0, 8)}...`;
            } else if (item.type === 'INVOICE_SENT') {
                statusColor = 'var(--primary-color)';
                directionText = `INVOICE SENT: ${item.amount.toFixed(2)} BVN requested from ${item.fromAddress.substring(0, 8)}...`;
            }

            historyItem.style.borderLeft = `5px solid ${statusColor}`;
            historyItem.innerHTML = `
                <div style="font-weight: bold; color: ${statusColor};">${directionText}</div>
                <div style="font-size: 0.8em; color: var(--secondary-color);">
                    ${new Date(item.timestamp).toLocaleString()}
                </div>
                <div style="font-size: 0.9em; margin-top: 5px;">
                    ${item.message.substring(0, 80)}
                </div>
            `;
            historyEl.appendChild(historyItem);
        });
    };

    window.toggleRequestMode = () => {
        const sendForm = document.getElementById('send-form');
        const requestForm = document.getElementById('request-form');
        const header = document.getElementById('transaction-header');
        const button = document.getElementById('toggle-request-mode-btn');

        if (sendForm.style.display !== 'none') {
            // Switch to Request Mode
            sendForm.style.display = 'none';
            requestForm.style.display = 'block';
            header.textContent = 'Request BitVen (Create Invoice)';
            button.textContent = 'Switch to Send Payment';
        } else {
            // Switch to Send Mode
            sendForm.style.display = 'block';
            requestForm.style.display = 'none';
            header.textContent = 'Send BitVen';
            button.textContent = 'Switch to Invoice Request';
        }
    };

    // --- 9. Final Initialization Call ---
    initializeBitVen();

</script>
</body>
</html>

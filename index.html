<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen Instant System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .admin-tag { background-color: #EF4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
        .success { color: #10B981; }
        .danger { color: #EF4444; }
        .scrollable-content { max-height: 400px; overflow-y: auto; }
        /* Simple Modal Backdrop */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); display: flex; 
            justify-content: center; align-items: center; z-index: 50; 
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-10">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // REQUIRED ADMIN IDENTITY
        const ADMIN_EMAIL = 'lanushomeappliances@gmail.com';
        const EXCHANGE_RATE_NGN = 1800.00; // 1 BVN = 1800 NGN

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let isAdmin = false;
        let profiles = {};
        let transactions = [];
        let balanceBVN = 0;

        const path = (collectionName, docId) => 
            docId ? 
            doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId) : 
            collection(db, 'artifacts', appId, 'public', 'data', collectionName);

        const profilesCollection = path('user_profiles_v2');
        const transactionsCollection = path('ledger_transactions_v3');
        const invoicesCollection = path('invoices_v2');

        const log = (message, type = 'log') => {
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `p-3 rounded-lg text-sm mb-4 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            }
            console.log(message);
        };

        const displayMessage = (text, type = 'info') => {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="card p-6 w-11/12 max-w-sm">
                    <h3 class="text-xl font-bold mb-4">${type === 'error' ? 'Error' : 'Notification'}</h3>
                    <p class="text-gray-600">${text}</p>
                    <button id="closeModal" class="mt-6 w-full py-2 rounded-md font-semibold text-white ${type === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeModal').onclick = () => document.body.removeChild(modal);
        };

        // --- Core Data Structures ---

        function createTransaction(sender, recipient, amount, type, reference = '') {
            return {
                timestamp: Date.now(),
                sender: sender,
                recipient: recipient,
                amount: amount,
                type: type, // 'payment', 'fee', 'bonus'
                reference: reference
            };
        }

        // --- UI Renders ---

        const formatCurrency = (amount) => {
            const formatted = parseFloat(amount).toFixed(2);
            return `₦${(formatted * EXCHANGE_RATE_NGN).toLocaleString('en-NG', { minimumFractionDigits: 2 })}`;
        };

        const calculateAndDisplayBalance = () => {
            let tempBalance = 0;
            const myUid = userId;
            
            // ADMIN Privilege: Infinite Balance
            if (isAdmin) { 
                tempBalance = Infinity;
            } else {
                transactions.forEach(tx => {
                    if (tx.sender === myUid) {
                        tempBalance -= tx.amount;
                    }
                    if (tx.recipient === myUid) {
                        tempBalance += tx.amount;
                    }
                });
            }

            balanceBVN = tempBalance;

            const balanceBVNEl = document.getElementById('balance-bvn');
            const balanceNGNEl = document.getElementById('balance-ngn');
            const balanceStatusEl = document.getElementById('balance-status');
            const sendButton = document.getElementById('send-bvn-button');
            const issueButton = document.getElementById('issue-bvn-button');

            if (balanceBVNEl) balanceBVNEl.textContent = isAdmin ? '∞' : balanceBVN.toFixed(2);
            if (balanceNGNEl) balanceNGNEl.textContent = isAdmin ? 'ADMIN' : formatCurrency(balanceBVN);
            
            if (balanceStatusEl) {
                balanceStatusEl.textContent = isAdmin ? 'STATUS: ADMIN (Infinite)' : (balanceBVN >= 0 ? 'STATUS: Solvent' : 'STATUS: Overdrawn');
                balanceStatusEl.classList.toggle('success', balanceBVN >= 0 || isAdmin);
                balanceStatusEl.classList.toggle('danger', balanceBVN < 0 && !isAdmin);
            }

            // Admin can always send, standard user needs non-zero balance
            if (sendButton) sendButton.disabled = !isAdmin && balanceBVN <= 0;
            if (issueButton) issueButton.disabled = !isAdmin;

            renderTransactionHistory();
            renderUserDirectory();
        };

        const renderTransactionHistory = () => {
            const historyBody = document.getElementById('transaction-history-body');
            if (!historyBody) return;

            historyBody.innerHTML = '';

            const sortedTransactions = [...transactions].sort((a, b) => b.timestamp - a.timestamp);

            sortedTransactions.forEach(tx => {
                const isSent = tx.sender === userId;
                const isReceived = tx.recipient === userId;
                const userReference = isSent ? (profiles[tx.recipient]?.email || tx.recipient) : (profiles[tx.sender]?.email || tx.sender);
                const amountText = tx.amount.toFixed(2);
                
                let direction, styleClass, icon;

                if (tx.type === 'bonus') {
                    direction = 'BONUS';
                    styleClass = 'text-yellow-600';
                    icon = '✨';
                } else if (isSent && tx.type === 'fee') {
                    direction = 'FEE';
                    styleClass = 'text-red-500';
                    icon = '⬇️';
                } else if (isSent) {
                    direction = `OUT to ${userReference}`;
                    styleClass = 'text-red-600';
                    icon = '⬇️';
                } else if (isReceived) {
                    direction = `IN from ${userReference}`;
                    styleClass = 'text-green-600';
                    icon = '⬆️';
                } else {
                    direction = 'N/A';
                    styleClass = 'text-gray-500';
                    icon = '';
                }

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium ${styleClass}">${icon} ${direction}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm ${styleClass}">${amountText} BVN</td>
                    <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${new Date(tx.timestamp).toLocaleString()}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-400 truncate max-w-[100px]">${tx.sender} / ${tx.recipient}</td>
                `;
                historyBody.appendChild(row);
            });
        };

        const renderUserDirectory = () => {
            const directoryBody = document.getElementById('directory-body');
            if (!directoryBody) return;

            directoryBody.innerHTML = '';
            
            // Use Object.values(profiles) which contains all loaded user data
            Object.values(profiles).filter(p => p.email).forEach(profile => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${profile.email}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs">${profile.uid}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${profile.isAdmin ? '<span class="admin-tag !bg-green-600">ADMIN</span>' : 'User'}</td>
                `;
                directoryBody.appendChild(row);
            });
        };

        // --- Core Logic ---

        const saveUserProfile = async (uid, email, displayName, userIsAdmin) => {
            const profileRef = path('user_profiles_v2', uid);
            try {
                await setDoc(profileRef, {
                    uid,
                    email,
                    displayName,
                    isAdmin: userIsAdmin,
                    lastSeen: Date.now(),
                }, { merge: true });
            } catch (error) {
                log('Failed to save profile: ' + error.message, 'error');
            }
        };

        const authenticate = async () => {
            try {
                log('Attempting authentication...');
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    log('No initial auth token provided. User must manually sign in via Google.');
                    document.getElementById('sign-in-button').onclick = async () => {
                        const provider = new GoogleAuthProvider();
                        try {
                            await signInWithPopup(auth, provider);
                        } catch (e) {
                            log('Google Sign-in failed: ' + e.message, 'error');
                        }
                    };
                }
            } catch (error) {
                log('Authentication failed: ' + error.message, 'error');
            }
        };
        
        const handleAuthChange = async (user) => {
            const authStatusEl = document.getElementById('auth-status');
            const authDetailsEl = document.getElementById('auth-details');
            const signInButton = document.getElementById('sign-in-button');
            const signOutButton = document.getElementById('sign-out-button');
            const adminIssueCard = document.getElementById('admin-issue-card');

            if (user) {
                userId = user.uid;
                const email = user.email || 'Anonymous';
                
                const userIsAdmin = email === ADMIN_EMAIL;
                isAdmin = userIsAdmin;

                await saveUserProfile(user.uid, email, user.displayName || 'Unknown User', isAdmin);

                authStatusEl.textContent = 'Authenticated';
                authStatusEl.className = 'text-green-600 font-bold';
                
                authDetailsEl.innerHTML = `
                    <p class="text-xs text-gray-500">UID: <span class="font-mono">${user.uid}</span></p>
                    <p class="text-xs text-gray-500">Email: ${email} ${isAdmin ? '<span class="admin-tag">ADMIN</span>' : ''}</p>
                `;
                
                signInButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');

                // Conditional display of Admin Card
                if (adminIssueCard) {
                    if (isAdmin) {
                        adminIssueCard.classList.remove('hidden');
                    } else {
                        adminIssueCard.classList.add('hidden');
                    }
                }

                startListeners();
                log(`User signed in. UID: ${user.uid}, Email: ${email}, Admin: ${isAdmin}`);

            } else {
                userId = null;
                isAdmin = false;
                authStatusEl.textContent = 'Signed Out';
                authStatusEl.className = 'text-red-600 font-bold';
                authDetailsEl.innerHTML = '<p class="text-sm text-gray-500">Please sign in to view and transact.</p>';
                
                signInButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');

                if (adminIssueCard) adminIssueCard.classList.add('hidden');

                profiles = {};
                transactions = [];
                balanceBVN = 0;
                calculateAndDisplayBalance();
            }
        };

        const sendBitVen = async (recipientId, amount) => {
            const FEE_AMOUNT = 0.01;
            const totalDebit = parseFloat(amount) + FEE_AMOUNT;
            const amountFloat = parseFloat(amount);

            if (amountFloat <= 0) {
                displayMessage('Payment amount must be greater than zero.', 'error');
                return;
            }

            if (amountFloat < FEE_AMOUNT) {
                displayMessage('Payment must be at least 0.01 BVN to cover the network fee.', 'error');
                return;
            }
            
            // ADMIN Privilege: Skip balance check
            if (!isAdmin && balanceBVN < totalDebit) {
                displayMessage(`Insufficient balance. Requires ${totalDebit.toFixed(2)} BVN (including 0.01 BVN fee). Current: ${balanceBVN.toFixed(2)} BVN`, 'error');
                return;
            }

            const sender = userId;
            const recipient = recipientId;
            const transactionRef = path('ledger_transactions_v3', 'TX' + Date.now() + Math.random().toString(36).substring(2, 9).toUpperCase());

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Core Payment Transaction
                    const paymentTx = createTransaction(sender, recipient, amountFloat, 'payment', 'P2P Transfer');
                    transaction.set(transactionRef, paymentTx);

                    // 2. Network Fee Transaction (sent from sender's account)
                    const feeTxRef = path('ledger_transactions_v3', 'FEE' + Date.now() + Math.random().toString(36).substring(2, 9).toUpperCase());
                    const feeTx = createTransaction(sender, sender, FEE_AMOUNT, 'fee', 'Network Fee');
                    transaction.set(feeTxRef, feeTx);
                });

                log(`Initiating instant payment: ${amountFloat} BVN from ${sender} to ${recipient}`);
                displayMessage(`Successfully sent ${amountFloat.toFixed(2)} BVN to ${profiles[recipient]?.email || recipient}. A ${FEE_AMOUNT.toFixed(2)} BVN network fee was applied.`);

            } catch (error) {
                log('Transaction failed: ' + error.message, 'error');
                displayMessage(`Transaction failed: ${error.message}`, 'error');
            }
        };

        const issueBitVen = async (recipientId, amount) => {
            if (!isAdmin) {
                displayMessage('Only administrators can issue new BVN.', 'error');
                return;
            }
            const amountFloat = parseFloat(amount);
            if (amountFloat <= 0) {
                displayMessage('Issue amount must be greater than zero.', 'error');
                return;
            }

            const recipient = recipientId;
            const transactionRef = path('ledger_transactions_v3', 'ISSUE' + Date.now() + Math.random().toString(36).substring(2, 9).toUpperCase());

            try {
                await runTransaction(db, async (transaction) => {
                    // Sender is 'NETWORK' for issuance
                    const bonusTx = createTransaction('NETWORK', recipient, amountFloat, 'bonus', 'Admin Issue / Network Bonus');
                    transaction.set(transactionRef, bonusTx);
                });

                log(`Admin issued ${amountFloat} BVN to ${recipient}`);
                displayMessage(`Successfully issued ${amountFloat.toFixed(2)} BVN to ${profiles[recipient]?.email || recipient}.`);

            } catch (error) {
                log('Issue transaction failed: ' + error.message, 'error');
                displayMessage(`Issue transaction failed: ${error.message}`, 'error');
            }
        };

        // --- Firebase Listeners ---

        const startListeners = () => {
            // 1. Profile Listener
            onSnapshot(profilesCollection, (snapshot) => {
                profiles = {};
                snapshot.forEach(doc => {
                    const profile = doc.data();
                    profiles[profile.uid] = profile;
                    if (profile.email) {
                        profiles[profile.email] = profile; // Index by email for lookups
                    }
                });
                log('User profiles snapshot received.');
                calculateAndDisplayBalance();
                renderUserDirectory();
            }, (error) => {
                log('Error listening to profiles: ' + error.message, 'error');
            });

            // 2. Transaction Log Listener
            onSnapshot(transactionsCollection, (snapshot) => {
                transactions = [];
                snapshot.forEach(doc => {
                    transactions.push(doc.data());
                });
                log('Transaction log snapshot received.');
                calculateAndDisplayBalance();
                renderTransactionHistory();
            }, (error) => {
                log('Error listening to transactions: ' + error.message, 'error');
            });

            // 3. Invoices Listener (Placeholder)
            onSnapshot(invoicesCollection, (snapshot) => {
                log('Invoices snapshot received.');
            }, (error) => {
                log('Error listening to invoices: ' + error.message, 'error');
            });
        };

        // --- Initial Setup ---

        const initializeBitVen = () => {
            onAuthStateChanged(auth, handleAuthChange);
            authenticate();

            document.getElementById('send-bvn-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recipientEmailOrId = document.getElementById('recipient-id').value.trim();
                const amount = document.getElementById('send-amount').value.trim();
                
                const recipientProfile = profiles[recipientEmailOrId];
                const recipientId = recipientProfile ? recipientProfile.uid : recipientEmailOrId;

                sendBitVen(recipientId, amount);
                e.target.reset();
            });

            document.getElementById('issue-bvn-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recipientEmailOrId = document.getElementById('issue-recipient-id').value.trim();
                const amount = document.getElementById('issue-amount').value.trim();

                const recipientProfile = profiles[recipientEmailOrId];
                const recipientId = recipientProfile ? recipientProfile.uid : recipientEmailOrId;

                issueBitVen(recipientId, amount);
                e.target.reset();
            });

            document.getElementById('sign-out-button').addEventListener('click', () => {
                signOut(auth);
            });
        };

        window.onload = initializeBitVen;
    </script>

    <div class="max-w-7xl mx-auto p-4">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                <span role="img" aria-label="Ven">💰</span> BitVen System
            </h1>
            <p class="text-gray-500 mt-1">Instant, Transparent, Digital Transactions</p>
        </header>

        <div id="status-message" class="p-3 rounded-lg text-sm mb-4 bg-blue-100 text-blue-700">Initializing...</div>

        <!-- Auth Status & Sign-In -->
        <div class="card p-6 mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Authentication Status</h2>
                <p id="auth-status" class="text-red-600 font-bold">Signed Out</p>
                <div id="auth-details" class="mt-2">
                    <p class="text-sm text-gray-500">Please sign in to view and transact.</p>
                </div>
            </div>
            <div class="mt-4 sm:mt-0">
                <button id="sign-in-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Sign In with Google</button>
                <button id="sign-out-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors hidden">Sign Out</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Wallet & Transactions -->
            <div class="lg:col-span-2">

                <!-- Wallet Card -->
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Your BitVen Wallet</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="mb-3 sm:mb-0">
                            <p class="text-sm text-gray-500">Balance (BVN)</p>
                            <h3 id="balance-bvn" class="text-4xl font-extrabold text-gray-900">0.00</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Approximate Value (NGN)</p>
                            <h3 id="balance-ngn" class="text-2xl font-bold text-gray-700">₦0.00</h3>
                            <p id="balance-status" class="text-sm mt-1 success">STATUS: Solvent</p>
                        </div>
                    </div>
                </div>

                <!-- Send Form -->
                <div class="card p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Send BitVen (P2P)</h2>
                    <form id="send-bvn-form" class="space-y-4">
                        <div>
                            <label for="recipient-id" class="block text-sm font-medium text-gray-700">Recipient Email or UID</label>
                            <input type="text" id="recipient-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="user@example.com or UID">
                        </div>
                        <div>
                            <label for="send-amount" class="block text-sm font-medium text-gray-700">Amount (BVN)</label>
                            <input type="number" step="0.01" min="0.01" id="send-amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g., 1.50">
                            <p class="text-xs text-gray-500 mt-1">Note: A 0.01 BVN network fee applies to all P2P transactions.</p>
                        </div>
                        <button type="submit" id="send-bvn-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors" disabled>
                            Send BVN
                        </button>
                    </form>
                </div>

                <!-- Admin Issue Form (Hidden by default, shown only for Admin) -->
                <div class="card p-6 mb-8 hidden" id="admin-issue-card">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Admin: Issue New BVN</h2>
                    <form id="issue-bvn-form" class="space-y-4">
                        <div>
                            <label for="issue-recipient-id" class="block text-sm font-medium text-gray-700">Recipient Email or UID</label>
                            <input type="text" id="issue-recipient-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="user@example.com or UID">
                        </div>
                        <div>
                            <label for="issue-amount" class="block text-sm font-medium text-gray-700">Amount (BVN)</label>
                            <input type="number" step="0.01" min="0.01" id="issue-amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g., 1000.00">
                        </div>
                        <button type="submit" id="issue-bvn-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors" disabled>
                            Issue New BVN
                        </button>
                    </form>
                </div>

            </div>

            <!-- Right Column: History & Directory -->
            <div class="lg:col-span-1">

                <!-- Transaction History -->
                <div class="card p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Transaction Log</h2>
                    <div class="scrollable-content">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Contact</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IDs</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-history-body" class="bg-white divide-y divide-gray-200">
                                <!-- Transactions will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Directory -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">User Directory</h2>
                    <div class="scrollable-content">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                </tr>
                            </thead>
                            <tbody id="directory-body" class="bg-white divide-y divide-gray-200">
                                <!-- Profiles will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

</body>
</html>

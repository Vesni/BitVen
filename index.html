<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The BitVen Wallet (BVN) - Clean Ledger</title>
    <!-- Include crypto-js for SHA256 Hashing (Used in Proof-of-Work) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* ================================================= */
        /* CSS Reset and Bright Theme Variables (No glow) */
        /* ================================================= */
        :root {
            --color-primary-accent: #2563EB; /* Blue 600 */
            --color-secondary-accent: #CA8A04; /* Yellow 700 */
            --color-background-light: #F9FAFB; /* Very Light Background */
            --color-card-light: #FFFFFF; /* White Card Background */
            --color-text-dark: #1F2937; /* Dark Gray Text */
            --color-text-subtle: #6B7280; /* Subtle Gray Text */
            --color-border: #E5E7EB; /* Light Gray Border */
            --color-success: #10B981; /* Green Success */
            --color-danger: #EF4444; /* Red Danger */
            --color-info: #6366F1; /* Indigo Info - Used for Admin highlight */
            
            /* Game/Ledger Constants */
            --tx-fee: 0.01; 
            --mining-difficulty: 5;
            --mining-reward: 0; 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            background-color: var(--color-background-light); 
            color: var(--color-text-dark); 
            line-height: 1.6; 
        }
        .container { 
            max-width: 1200px; 
            margin: 30px auto; 
            padding: 30px; 
            border-radius: 16px; 
            background: var(--color-card-light); 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); 
            border: 1px solid var(--color-border);
        }
        h1 { 
            color: var(--color-primary-accent); 
            text-align: center; 
            margin-bottom: 40px; 
            font-size: 2.5em; 
            font-weight: 800;
        }
        h2 { 
            color: var(--color-info); 
            border-bottom: 2px solid var(--color-border); 
            padding-bottom: 12px; 
            margin-top: 0; 
            font-size: 1.6em; 
            font-weight: 700;
        }
        
        /* Layout Grid */
        #main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; margin-top: 20px; }
        .section { 
            padding: 20px; 
            border-radius: 12px; 
            background: var(--color-card-light); 
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            margin-bottom: 25px; 
        }

        /* Inputs & Buttons */
        input, select { 
            padding: 12px; 
            margin-right: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #D1D5DB; 
            border-radius: 8px; 
            background: #F9FAFB; 
            color: var(--color-text-dark); 
            box-sizing: border-box; 
            transition: all 0.2s;
        }
        input:focus { border-color: var(--color-primary-accent); outline: none; background: var(--color-card-light); }
        .input-full { width: calc(100% - 10px); }
        .input-half { width: calc(50% - 10px); }

        button { 
            background-color: var(--color-primary-accent); 
            color: var(--color-card-light); 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-right: 10px; 
            transition: all 0.2s ease; 
            font-weight: 600;
            box-shadow: 0 4px 0 #1D4ED8; /* Darker blue for shadow */
        }
        button:hover:not(:disabled) { 
            background-color: #1D4ED8; /* Slightly darker primary on hover */
            box-shadow: 0 2px 0 #1D4ED8; 
            transform: translateY(2px); 
        }
        button:disabled { 
            background-color: #D1D5DB; 
            color: #9CA3AF;
            cursor: not-allowed; 
            box-shadow: none; 
            transform: none; 
        }
        
        /* Specific Button Styles */
        #mine-btn { background-color: var(--color-success); box-shadow: 0 4px 0 #059669; }
        #mine-btn:hover:not(:disabled) { background-color: #059669; box-shadow: 0 2px 0 #059669; }

        /* Wallet Info */
        .wallet-info-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--color-border); margin-bottom: 15px; }
        .balance-display { font-size: 3em; font-weight: 900; color: var(--color-success); }
        .balance-label { color: var(--color-text-subtle); font-size: 0.8em; margin-bottom: 5px; }
        #wallet-id-container { font-size: 0.9em; word-break: break-all; margin-top: 15px; color: var(--color-text-dark); }
        code { background: #F3F4F6; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; border: 1px solid #E5E7EB; }
        
        /* Directory/List Styling */
        #user-directory-output, #chain-output { max-height: 450px; overflow-y: auto; background: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid var(--color-border); }
        .directory-item, .request-card, .block-card { padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .directory-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--color-border); }
        .directory-item:last-child { border-bottom: none; }

        /* Block Explorer */
        .block-card { background: var(--color-card-light); border: 1px solid #D1D5DB; }
        .block-header { display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold; margin-bottom: 8px; color: var(--color-info); }
        .fee-info { color: var(--color-secondary-accent); font-weight: normal; font-size: 0.8em; }
        .tx-list li { margin-bottom: 5px; font-size: 0.9em; border-left: 2px solid #D1D5DB; padding-left: 10px; color: var(--color-text-subtle);}
        .reward-tx { color: var(--color-success); font-weight: 600; }
        
        /* Responsive */
        @media (max-width: 900px) {
            #main-grid { grid-template-columns: 1fr; gap: 30px; }
            .container { margin: 10px; padding: 15px; }
            .input-full, .input-half, button { width: 100%; margin-right: 0; margin-bottom: 15px; }
            .balance-display { font-size: 2.5em; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‚õìÔ∏è BitVen Blockchain Ledger (v3)</h1>
    
    <!-- ADMIN INSTRUCTION BAR -->
    <div style="padding: 10px; margin-bottom: 20px; border-radius: 8px; background: #FEF3C7; border: 1px solid #FCD34D;">
        <p style="color: #92400E; font-size: 0.9em; margin: 0; font-weight: 600;">
            üîë **Admin Setup:** To enable **Unlimited BitVen**, please edit the **`MASTER_ADMIN_UID`** variable in the code below 
            and replace the placeholder with your actual Firebase UID (visible after Google Sign-In).
        </p>
    </div>

    <!-- WALLET INFO & AUTH SECTION -->
    <div class="section">
        <div class="wallet-info-bar">
            <div>
                <div class="balance-label">Current Balance</div>
                <div class="balance-display"><span id="current-balance">0.00</span> BVN</div>
            </div>
            <div>
                <!-- FIXED: Calls global window functions -->
                <button id="sign-in-btn" onclick="window.signInWithGoogle()">Sign In/Wallet Login</button>
                <button id="sign-out-btn" onclick="window.signOutUser()" style="display: none;">Sign Out</button>
                <button onclick="window.calculateAndDisplayBalance(window.blocksData)" style="margin-left: 10px;">Refresh Balance</button>
            </div>
        </div>
        <div id="wallet-id-container">
            <strong>Active Wallet ID:</strong> <code id="wallet-id">N/A</code>
            <!-- FIXED: Calls global window functions -->
            <button class="copy-btn" onclick="window.copyWalletId()" title="Copy ID" style="padding: 6px 10px; margin-left: 10px; font-size: 0.8em;">üìã</button>
            <span id="auth-status" style="margin-left: 20px; font-weight: 600; color: var(--color-danger);">Signed Out</span>
            <span id="copy-status" style="font-size: 0.8em; margin-left: 10px; color: var(--color-success);"></span>
        </div>
    </div>

    <div id="main-grid">
        <!-- LEFT COLUMN: Transactions, Mining -->
        <div>
            <!-- MINING SECTION (Proof-of-Work) -->
            <div class="section">
                <h2>‚õèÔ∏è Proof-of-Work & Fees</h2>
                <p style="font-size: 0.9em; color: var(--color-text-dark); border-bottom: 1px dashed var(--color-border); padding-bottom: 10px;">
                    **Tx Fee:** <span id="tx-fee-display">0.01</span> BVN | 
                    **Base Reward:** <span id="reward-display" style="color: var(--color-danger); font-weight: bold;">0.00</span> BVN (Miners earn transaction fees only). | 
                    **Difficulty (Leading Zeros):** <span id="difficulty-display">5</span>.
                </p>
                
                <p style="color: var(--color-text-subtle);">
                    Pending Transactions: <span id="pending-tx-count">0</span> | Total Fees in Pool: <strong id="fees-pool">0.00</strong> BVN
                </p>
                <!-- FIXED: Calls global window functions -->
                <button id="mine-btn" onclick="window.mineBlock()" disabled>
                    Mine Block (Start Calculation)
                </button>
                <p id="mining-status" style="font-size: 0.9em; color: var(--color-primary-accent); margin-top: 10px; font-weight: 600;"></p>
            </div>

            <!-- TRANSACTION & INVOICE SECTION -->
            <div class="section">
                <h2 id="tx-section-title">üí∏ Send BitVen</h2>
                <input type="text" id="recipient-id" placeholder="Recipient Wallet ID (UID) or Burn Address" class="input-full">
                <input type="number" id="amount" placeholder="Amount (BVN)" value="1.00" min="0.01" step="any" class="input-half">
                <input type="text" id="message" placeholder="Optional Memo/Reason" class="input-half">
                <!-- FIXED: Calls global window functions -->
                <button id="send-btn" onclick="window.sendTransaction()">Submit Transaction</button>
                <button id="request-btn" onclick="window.toggleRequestMode()" style="background-color: var(--color-info); box-shadow: 0 4px 0 #4F46E5;">
                    Switch to Invoice Request
                </button>
                <p style="font-size: 0.8em; color: var(--color-text-subtle); margin-top: 5px;">
                    <strong style="color: var(--color-danger);">NOTE:</strong> All transactions require a ${TX_FEE} BVN fee. The **Burn Address** is permanent.
                </p>
                <p id="tx-status" style="color: var(--color-primary-accent); margin-top: 10px; font-weight: 600;"></p>
            </div>
            
            <!-- INCOMING INVOICES -->
            <div class="section">
                <h2>üì• Incoming Invoices (Pay Now)</h2>
                <div id="pending-requests-output">
                    <p style="color: var(--color-text-subtle);">Sign in to check for pending invoices.</p>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: Directory & Block Explorer -->
        <div>
            <!-- USER DIRECTORY -->
            <div class="section">
                <h2>üë• User Directory</h2>
                <p style="font-size: 0.9em; color: var(--color-text-subtle);">Publicly visible wallets (Total: <span id="directory-count">0</span>)</p>
                <div id="user-directory-output">
                    <p style="color: var(--color-text-subtle);">Loading user directory...</p>
                </div>
            </div>

            <!-- BLOCK EXPLORER -->
            <div class="section">
                <h2>üîç Block Explorer</h2>
                <p style="color: var(--color-text-subtle);">
                    Total Blocks: <span id="chain-length">0</span> | Chain Status: <span id="chain-valid" style="font-weight: bold;">Checking...</span>
                </p>
                <div id="chain-output">
                    <!-- Blocks will be injected here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // ====================================================================
    // 1. CONFIGURATION & FIREBASE SETUP
    // ====================================================================
    
    // Import necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, getDocs, addDoc, query, orderBy, limit,
        onSnapshot, writeBatch, doc, setDoc, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');
    
    // --- LEDGER CONSTANTS & ADMIN CONFIGURATION ---
    const BURN_ADDRESS = 'BVN_BURN_ADDRESS_0x0000000000000000000000000000000000000000';
    const MINING_DIFFICULTY = 5; 
    const MINING_REWARD = 0.00; 
    const TX_FEE = 0.01;

    // !!! ADMINISTRATOR CONFIGURATION !!!
    const MASTER_ADMIN_UID = 'REPLACE_THIS_WITH_YOUR_ACTUAL_ADMIN_UID'; 
    const UNLIMITED_BALANCE = 999999999.00;

    // Environment-provided globals (will be available even if Firebase fails)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase instances (initialized later)
    let db = null;
    let auth = null;
    let CHAIN_REF = null;
    let PENDING_TX_REF = null;
    let USER_PROFILE_REF = null;

    // App State
    let currentUserId = null;
    let isAuthReady = false;
    let isRequestMode = false;
    window.blocksData = []; // Expose globally for the "Refresh Balance" button
    let userProfiles = [];

    // --- CRITICAL FIX: Robust Firebase Initialization ---
    let firebaseConfig = {};
    try {
        const configString = typeof __firebase_config === 'string' && __firebase_config.trim() !== '' 
            ? __firebase_config : null;
            
        if (configString) {
            firebaseConfig = JSON.parse(configString); 
            
            // Check for critical missing project ID (Fixes the root FirebaseError)
            if (!firebaseConfig.projectId) {
                console.error("Firebase config is missing projectId. Initializing stopped.");
                firebaseConfig = {}; // Clear config if invalid
            }
        }
    } catch (e) {
        console.error("Error parsing __firebase_config:", e);
        // Do not proceed with initialization
    }

    if (Object.keys(firebaseConfig).length > 0) {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Define references ONLY after db is successfully initialized
            CHAIN_REF = collection(db, `/artifacts/${appId}/public/data/blockchain_chain_v2`);
            PENDING_TX_REF = collection(db, `/artifacts/${appId}/public/data/pending_transactions_v2`);
            USER_PROFILE_REF = collection(db, `/artifacts/${appId}/public/data/user_profiles_v2`);
            
        } catch (e) {
            console.error("Firebase app initialization failed, despite config being present:", e);
            db = null; // Ensure db is explicitly null if initialization failed
        }
    } else {
        console.error("Firebase config is missing or invalid. Application will not connect to Firestore.");
    }


    // ====================================================================
    // 2. CORE BLOCKCHAIN CLASSES (No changes needed here)
    // ====================================================================
    
    class Transaction {
        constructor(fromAddress, toAddress, amount, message = '', isRequest = false, fee = 0) {
            this.fromAddress = fromAddress;
            this.toAddress = toAddress;
            this.amount = window.parseAndRound(amount);
            this.message = message;
            this.isRequest = isRequest; 
            this.fee = window.parseAndRound(fee);
        }
    }

    class Block {
        constructor(index, transactions, previousHash = '') {
            this.index = index;
            this.timestamp = Date.now(); 
            this.transactions = transactions;
            this.previousHash = previousHash;
            this.nonce = 0; 
            this.hash = this.calculateHash();
        }

        calculateHash() {
            return CryptoJS.SHA256(
                this.index + 
                this.previousHash + 
                this.timestamp + 
                this.nonce + 
                JSON.stringify(this.transactions.map(tx => ({
                    from: tx.fromAddress, 
                    to: tx.toAddress, 
                    amt: tx.amount, 
                    msg: tx.message, 
                    fee: tx.fee,
                }))) 
            ).toString();
        }

        mineBlock(difficulty) {
            const target = Array(difficulty + 1).join("0"); 
            while (this.hash.substring(0, difficulty) !== target) {
                this.nonce++;
                this.hash = this.calculateHash();
            }
        }
    }

    // ====================================================================
    // 3. GLOBAL STATE, AUTH, & UI MANAGEMENT (ALL FUNCTIONS EXPOSED TO WINDOW)
    // ====================================================================

    // --- UTILITY FUNCTIONS ---
    
    /** Rounds a number to two decimal places for currency consistency. */
    window.parseAndRound = (value) => {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : Math.round(num * 100) / 100;
    };

    /** Formats a number to two decimal places string. */
    window.formatCurrency = (value) => {
        return window.parseAndRound(value).toFixed(2);
    };

    /** Updates initial UI with ledger constants. */
    const updateConstantsUI = () => {
        document.getElementById('tx-fee-display').textContent = window.formatCurrency(TX_FEE);
        document.getElementById('reward-display').textContent = window.formatCurrency(MINING_REWARD);
        document.getElementById('difficulty-display').textContent = MINING_DIFFICULTY;
    }
    updateConstantsUI(); 

    // --- AUTH UI AND LOGIC ---
    // FIXED: Function assigned to window
    window.signInWithGoogle = () => {
        if (!auth) {
            console.error("Firebase Auth not initialized. Cannot sign in.");
            return;
        }
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' }); 
        signInWithPopup(auth, provider).catch((error) => console.error("Google Sign-In Error:", error));
    };

    // FIXED: Function assigned to window
    window.signOutUser = () => {
        if (!auth) return;
        signOut(auth).catch((error) => console.error("Sign Out Error:", error));
    };
    
    window.copyIdToClipboard = (idToCopy, statusElementId = 'copy-status') => {
        const statusEl = document.getElementById(statusElementId);
        if (idToCopy) {
            try {
                const el = document.createElement('textarea');
                el.value = idToCopy;
                el.style.position = 'fixed'; document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                statusEl.textContent = '‚úÖ Copied!';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (err) {
                console.error('Could not copy text: ', err);
                statusEl.textContent = '‚ùå Failed to copy.';
            }
        }
    };

    // FIXED: Function assigned to window
    window.copyWalletId = () => {
        const walletId = document.getElementById('wallet-id').textContent;
        window.copyIdToClipboard(walletId);
    }

    // FIXED: Function assigned to window
    window.toggleRequestMode = () => {
        isRequestMode = !isRequestMode;
        const sendBtn = document.getElementById('send-btn');
        const requestBtn = document.getElementById('request-btn');
        const txTitle = document.getElementById('tx-section-title');
        const recipientInput = document.getElementById('recipient-id');

        if (isRequestMode) {
            txTitle.textContent = 'üìù Create Invoice Request';
            sendBtn.textContent = 'Send Invoice';
            sendBtn.onclick = window.requestFunds;
            requestBtn.textContent = 'Switch to Send BitVen';
            recipientInput.placeholder = 'Debtor Wallet ID (UID)';
        } else {
            txTitle.textContent = 'üí∏ Send BitVen';
            sendBtn.textContent = 'Submit Transaction';
            sendBtn.onclick = window.sendTransaction;
            requestBtn.textContent = 'Switch to Invoice Request';
            recipientInput.placeholder = 'Recipient Wallet ID (UID) or Burn Address';
        }
        document.getElementById('tx-status').textContent = '';
        document.getElementById('recipient-id').value = '';
        document.getElementById('amount').value = '1.00';
        document.getElementById('message').value = '';
    }

    // --- AUTH STATE CHANGE LISTENER ---
    const setupListeners = () => {
        if (!db) return;

        // Listener for the Blockchain
        onSnapshot(CHAIN_REF, (snapshot) => {
            window.blocksData = [];
            snapshot.forEach(doc => window.blocksData.push({...doc.data(), id: doc.id}));
            
            window.blocksData.sort((a, b) => a.index - b.index);

            displayChain(window.blocksData);
            checkChainValidity(window.blocksData);
            if (currentUserId) {
                window.calculateAndDisplayBalance(window.blocksData);
            }
        }, (error) => console.error("Blockchain Snapshot Error:", error));
    
        // Listener for Pending Transactions
        onSnapshot(PENDING_TX_REF, (snapshot) => {
            const pendingTxs = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));

            const realTxs = pendingTxs.filter(tx => !tx.isRequest);
            const feesPool = realTxs.reduce((sum, tx) => sum + window.parseAndRound(tx.fee), 0);
            
            document.getElementById('pending-tx-count').textContent = realTxs.length;
            document.getElementById('fees-pool').textContent = window.formatCurrency(feesPool);

            if (currentUserId) {
                const requests = pendingTxs.filter(tx => tx.isRequest && tx.toAddress === currentUserId);
                displayRequests(requests);
            } else {
                document.getElementById('pending-requests-output').innerHTML = '<p style="color: var(--color-text-subtle);">Sign in to check for pending invoices.</p>';
            }
        }, (error) => console.error("Pending TX Snapshot Error:", error));

        // Listener for the User Directory
        onSnapshot(USER_PROFILE_REF, (snapshot) => {
            userProfiles = [];
            snapshot.forEach(doc => userProfiles.push(doc.data()));
            displayUserDirectory(userProfiles);
        }, (error) => console.error("User Directory Snapshot Error:", error));
    }


    if (auth) {
        onAuthStateChanged(auth, (user) => {
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const walletIdCode = document.getElementById('wallet-id');
            const statusSpan = document.getElementById('auth-status');
            const mineBtn = document.getElementById('mine-btn');
            isAuthReady = true;

            if (user && user.isAnonymous === false) {
                currentUserId = user.uid;
                
                // 1. Update User Profile for Directory
                if (db) {
                    const userProfileRef = doc(db, USER_PROFILE_REF.path, user.uid);
                    setDoc(userProfileRef, { 
                        uid: user.uid, 
                        displayName: user.displayName || 'Wallet User', 
                        lastSeen: serverTimestamp() 
                    }, { merge: true }).catch(e => console.error("Error saving user profile:", e));
                }

                // 2. UI Update
                walletIdCode.textContent = currentUserId;
                statusSpan.innerHTML = `Signed In: ${user.displayName || 'User'}`;
                statusSpan.style.color = 'var(--color-primary-accent)';
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
                mineBtn.disabled = false;
                
                window.calculateAndDisplayBalance(window.blocksData); 

            } else if (user) { // Includes anonymous sign-in
                currentUserId = user.uid; 
                walletIdCode.textContent = user.isAnonymous ? currentUserId.substring(0, 15) + '... (Anon)' : currentUserId;
                statusSpan.innerHTML = user.isAnonymous ? 'Anonymous' : 'Signed In';
                statusSpan.style.color = user.isAnonymous ? 'var(--color-secondary-accent)' : 'var(--color-primary-accent)';
                signInBtn.style.display = user.isAnonymous ? 'inline-block' : 'none';
                signOutBtn.style.display = 'inline-block';
                mineBtn.disabled = false;
                window.calculateAndDisplayBalance(window.blocksData);
                
            } else {
                // Fully Signed out
                currentUserId = null;
                walletIdCode.textContent = 'N/A';
                statusSpan.innerHTML = 'Signed Out';
                statusSpan.style.color = 'var(--color-danger)';
                document.getElementById('current-balance').textContent = '0.00';
                document.querySelector('.balance-label').textContent = 'Current Balance'; // Reset label
                signInBtn.style.display = 'inline-block';
                signOutBtn.style.display = 'none';
                mineBtn.disabled = true;
            }
            
            // Start listeners only once auth is ready and db is connected
            if (db && isAuthReady) {
                setupListeners();
            }
        });
    }

    // Initial Authentication attempt
    const attemptAuth = async () => {
        if (!auth) return;
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Initial Authentication failed:", e);
        }
    };
    attemptAuth();
    
    // ====================================================================
    // 4. TRANSACTION & MINING LOGIC (FUNCTIONS EXPOSED TO WINDOW)
    // ====================================================================

    // --- Client-side Validation ---
    const validateTransactionInput = (toAddress, amount, isSending = true) => {
        // Implementation remains the same
        const parsedAmount = window.parseAndRound(amount);
        const txStatus = document.getElementById('tx-status');
        const currentBalance = window.parseAndRound(document.getElementById('current-balance').dataset.calculatedBalance || 0);
        const isAdmin = currentUserId === MASTER_ADMIN_UID;


        if (!currentUserId) { txStatus.textContent = "Error: Please sign in to perform this action."; return false; }
        if (!toAddress) { txStatus.textContent = "Error: Recipient ID is required."; return false; }
        if (isNaN(parsedAmount) || parsedAmount <= 0) { txStatus.textContent = "Error: Invalid or zero amount."; return false; }
        if (toAddress === currentUserId) { 
            txStatus.textContent = isSending ? "Error: Cannot send to yourself." : "Error: Cannot invoice yourself."; 
            return false; 
        }

        if (isSending && !isAdmin) { // Only check balance if NOT admin
            const totalCost = parsedAmount + TX_FEE;
            if (currentBalance < totalCost) { 
                txStatus.textContent = `Error: Insufficient funds. Need ${window.formatCurrency(totalCost)} BVN (Amount + Fee).`; 
                return false; 
            }
        }
        return true;
    };

    // --- STANDARD TRANSACTION (Send/Burn) ---
    // FIXED: Function assigned to window
    window.sendTransaction = async () => {
        if (!db) { document.getElementById('tx-status').textContent = "Error: Database connection failed."; return; }
        
        const toAddress = document.getElementById('recipient-id').value.trim();
        const amount = document.getElementById('amount').value;
        const message = document.getElementById('message').value.trim();
        const txStatus = document.getElementById('tx-status');
        
        if (!validateTransactionInput(toAddress, amount, true)) return;
        
        const parsedAmount = window.parseAndRound(amount);
        const totalCost = parsedAmount + TX_FEE;
        const txMessage = toAddress === BURN_ADDRESS ? `üî• BURN: ${message}` : message;
        
        // Create the transaction object
        const newTx = new Transaction(currentUserId, toAddress, parsedAmount, txMessage, false, TX_FEE);
        
        try {
            await addDoc(PENDING_TX_REF, { ...newTx, timestamp: serverTimestamp() });
            txStatus.textContent = `Transaction submitted! Total cost: ${window.formatCurrency(totalCost)} BVN. (Pending mining)`;
            document.getElementById('recipient-id').value = '';
            document.getElementById('amount').value = '1.00';
            document.getElementById('message').value = '';

        } catch (e) {
            txStatus.textContent = "Error submitting transaction: " + e.message;
            console.error("Error submitting transaction: ", e);
        }
    };

    // --- INVOICE REQUEST ---
    // FIXED: Function assigned to window
    window.requestFunds = async () => {
        if (!db) { document.getElementById('tx-status').textContent = "Error: Database connection failed."; return; }
        
        const debtorId = document.getElementById('recipient-id').value.trim();
        const amount = document.getElementById('amount').value;
        const message = document.getElementById('message').value.trim();
        const requestStatus = document.getElementById('tx-status');
        
        if (!validateTransactionInput(debtorId, amount, false)) return;

        const parsedAmount = window.parseAndRound(amount);
        // Note: fromAddress and toAddress are swapped for a request (From: Debtor, To: Creditor)
        const requestTx = new Transaction(debtorId, currentUserId, parsedAmount, `INVOICE: ${message}`, true, 0);
        
        try {
            await addDoc(PENDING_TX_REF, { ...requestTx, timestamp: serverTimestamp() });
            requestStatus.textContent = `Invoice created for ${debtorId.substring(0, 10)}... for ${window.formatCurrency(parsedAmount)} BVN. (Awaiting payment)`;
            document.getElementById('recipient-id').value = '';
            document.getElementById('amount').value = '5.00';
            document.getElementById('message').value = '';

        } catch (e) {
            requestStatus.textContent = "Error submitting request: " + e.message;
            console.error("Error submitting request: ", e);
        }
    };

    // --- MINING ---
    // FIXED: Function assigned to window
    window.mineBlock = async () => {
        if (!currentUserId || !db) { document.getElementById('mining-status').textContent = "Error: Not signed in or database unavailable."; return; }

        const mineBtn = document.getElementById('mine-btn');
        const miningStatus = document.getElementById('mining-status');
        mineBtn.disabled = true;
        miningStatus.textContent = "Mining in progress... Proof-of-Work calculation started.";

        // 1. Get ONLY non-request Pending Transactions
        const txQuery = query(PENDING_TX_REF, orderBy('timestamp'));
        const txSnapshot = await getDocs(txQuery);
        
        const allPendingDocs = txSnapshot.docs;
        const transactionsToMine = allPendingDocs
            .filter(doc => !doc.data().isRequest)
            .map(doc => ({...doc.data(), id: doc.id})); 
        
        if (transactionsToMine.length === 0) {
             miningStatus.textContent = "No valid transactions to mine. Mining aborted.";
             mineBtn.disabled = false;
             return;
        }
        
        // Calculate total fees
        const totalFees = transactionsToMine.reduce((sum, tx) => sum + tx.fee, 0);
        const finalReward = MINING_REWARD + totalFees;

        // 2. Get Last Block Hash and Index
        let previousHash = Array(MINING_DIFFICULTY + 1).join("0") + 'GENESIS_HASH'; 
        let nextIndex = 0;
        
        const lastBlockQuery = query(CHAIN_REF, orderBy('index', 'desc'), limit(1));
        const lastBlockSnapshot = await getDocs(lastBlockQuery);

        lastBlockSnapshot.forEach(doc => {
            const lastBlock = doc.data();
            previousHash = lastBlock.hash;
            nextIndex = lastBlock.index + 1;
        });
        
        // 3. Add Mining Reward Transaction (Base 0 + Fees)
        const rewardTx = new Transaction('SYSTEM_REWARD', currentUserId, finalReward, `Mining Reward (Fees: ${window.formatCurrency(totalFees)})`, false, 0);
        transactionsToMine.push(rewardTx);

        // 4. Create and Mine New Block
        const newBlock = new Block(nextIndex, transactionsToMine, previousHash);
        
        newBlock.mineBlock(MINING_DIFFICULTY); 
        miningStatus.textContent = `Verification successful. Block ${newBlock.index} found. Committing...`;

        // 5. Commit to Firestore using a batch
        const batch = writeBatch(db);

        // A. Add the new block
        batch.set(doc(CHAIN_REF), { ...newBlock, timestamp: serverTimestamp() });

        // B. Delete all PENDING transactions that were just mined
        allPendingDocs.filter(doc => !doc.data().isRequest).forEach(doc => {
            batch.delete(doc.ref);
        });

        try {
            await batch.commit();
            miningStatus.textContent = `‚úÖ Block #${newBlock.index} MINED! Reward: ${window.formatCurrency(finalReward)} BVN (Fees).`;
        } catch (e) {
            miningStatus.textContent = "‚ùå Error committing block: " + e.message;
            console.error("Error committing block: ", e);
        } finally {
            mineBtn.disabled = false;
        }
    };
    
    // ====================================================================
    // 5. DATA DISPLAY FUNCTIONS (Exposed globally for reuse)
    // ====================================================================
    
    window.populateSendForm = (recipientId, amount) => {
        if (isRequestMode) window.toggleRequestMode(); // Switch back to send mode
        document.getElementById('recipient-id').value = recipientId;
        document.getElementById('amount').value = amount;
        document.getElementById('tx-section-title').scrollIntoView({ behavior: 'smooth' });
    };

    // --- Balance Calculation (Including Admin Override) ---
    window.calculateAndDisplayBalance = (blocks) => {
        if (!currentUserId || !isAuthReady) return;
        
        const balanceDisplay = document.getElementById('current-balance');
        const balanceLabel = document.querySelector('.balance-label');
        
        const isAdmin = currentUserId === MASTER_ADMIN_UID;

        if (isAdmin) {
            balanceDisplay.textContent = '‚àû'; 
            balanceDisplay.style.fontSize = '3.5em';
            balanceDisplay.style.color = 'var(--color-info)'; 
            balanceLabel.textContent = 'Current Balance (ADMIN MODE)';
            
            // Store the high numerical value for the admin's balance check bypass
            balanceDisplay.dataset.calculatedBalance = UNLIMITED_BALANCE;
            return; 
        }

        // --- STANDARD USER LOGIC ---
        balanceDisplay.style.fontSize = '3em'; 
        balanceDisplay.style.color = 'var(--color-success)'; 
        balanceLabel.textContent = 'Current Balance'; 

        let balance = 0;
        for (const block of blocks) {
            for (const tx of block.transactions) {
                if (tx.isRequest) continue; 
                
                // Debit (Sender)
                if (tx.fromAddress === currentUserId) {
                    balance -= (window.parseAndRound(tx.amount) + window.parseAndRound(tx.fee)); 
                }
                // Credit (Recipient/Miner Reward)
                if (tx.toAddress === currentUserId) {
                    balance += window.parseAndRound(tx.amount);
                }
            }
        }
        balanceDisplay.textContent = window.formatCurrency(balance);
        // Store the actual balance for standard user's balance check
        balanceDisplay.dataset.calculatedBalance = balance;
    }

    // --- Directory Display ---
    function displayUserDirectory(users) {
        // Implementation remains the same
        const output = document.getElementById('user-directory-output');
        document.getElementById('directory-count').textContent = users.length;
        if (!output) return;

        const currentUsers = users.filter(u => u.uid !== currentUserId);

        if (currentUsers.length === 0) {
            output.innerHTML = '<p style="color: var(--color-text-subtle);">No other active users found.</p>';
            return;
        }

        output.innerHTML = currentUsers.map(user => {
            const uidShort = user.uid.substring(0, 12) + '...';
            const statusElementId = `copy-status-dir-${user.uid}`;
            
            return `
                <div class="directory-item">
                    <div class="user-details">
                        <span style="font-weight: 600; color: var(--color-info);">${user.displayName || 'Anon User'}</span>
                        <code title="Wallet ID: ${user.uid}" style="margin-left: 10px;">${uidShort}</code>
                        <span id="${statusElementId}" class="copy-status-inline"></span>
                    </div>
                    <button style="padding: 6px 12px; font-size: 0.8em; box-shadow: none; transform: none; background-color: var(--color-secondary-accent);"
                            onclick="window.copyIdToClipboard('${user.uid}', '${statusElementId}')">
                        Copy ID
                    </button>
                </div>
            `;
        }).join('');
    }

    // --- Incoming Request/Invoice Display ---
    function displayRequests(requests) {
        // Implementation remains the same
        const output = document.getElementById('pending-requests-output');
        if (!output) return; 
        
        if (requests.length === 0) {
            output.innerHTML = '<p style="color: var(--color-text-subtle);">No pending invoices sent to you. You are debt-free!</p>';
            return;
        }

        output.innerHTML = requests.map(req => {
            const debtor = (req.fromAddress || 'N/A').substring(0, 10) + '...';
            return `
                <div class="request-card" style="border-left: 5px solid var(--color-primary-accent); background: #F3F4F6;">
                    <span style="font-size: 1.1em; font-weight: bold; color: var(--color-primary-accent);">${window.formatCurrency(req.amount)} BVN</span> requested by: 
                    <code title="Debtor ID: ${req.fromAddress}">${debtor}</code>
                    <p style="font-size: 0.9em; color: var(--color-text-subtle); margin: 5px 0 10px 0;">Reason: <em>${req.message.replace('INVOICE: ', '')}</em></p>
                    <button style="padding: 8px 15px; font-size: 0.9em; background-color: var(--color-success); box-shadow: 0 3px 0 #059669;"
                            onclick="window.populateSendForm('${req.fromAddress}', ${window.formatCurrency(req.amount)})">
                        Pay Now
                    </button>
                </div>
            `;
        }).join('');
    }

    // --- Block Explorer Display ---
    function displayChain(blocks) {
        // Implementation remains the same
        const output = document.getElementById('chain-output');
        output.innerHTML = '';
        document.getElementById('chain-length').textContent = blocks.length;

        // Display blocks in reverse chronological order
        [...blocks].reverse().forEach(block => {
            const totalFees = block.transactions
                .filter(tx => !tx.isRequest && tx.fee > 0)
                .reduce((sum, tx) => sum + window.parseAndRound(tx.fee), 0);

            const txList = block.transactions
                .filter(tx => !tx.isRequest) 
                .map(tx => {
                const from = (tx.fromAddress || 'N/A').substring(0, 10) + '...';
                const to = (tx.toAddress || 'N/A').substring(0, 10) + '...';
                const isReward = tx.fromAddress === 'SYSTEM_REWARD';
                const isBurn = tx.toAddress === BURN_ADDRESS;

                let txDetails = '';
                if (isReward) {
                    txDetails = `üí∞ Reward (Fees): ${window.formatCurrency(tx.amount)} BVN`;
                } else if (isBurn) {
                    txDetails = `üî• BURN: ${window.formatCurrency(tx.amount)} BVN (Fee: ${window.formatCurrency(tx.fee)})`;
                } else {
                    txDetails = `Sent: ${window.formatCurrency(tx.amount)} BVN (Fee: ${window.formatCurrency(tx.fee)})`;
                }

                return `
                    <li class="${isReward ? 'reward-tx' : ''}">
                        ${txDetails} | From: <code title="From ID: ${tx.fromAddress}">${from}</code> 
                        | To: <code title="To ID: ${tx.toAddress}">${to}</code>
                    </li>`;
            }).join('');

            const date = new Date(block.timestamp).toLocaleString();

            const blockHtml = `
                <div class="block-card">
                    <div class="block-header">
                        <span>Block #${block.index}</span> 
                        <span class="fee-info">Total Fees: ${window.formatCurrency(totalFees)} BVN</span>
                    </div>
                    <p style="font-size: 0.8em; margin: 5px 0; color: var(--color-text-subtle);">
                        Timestamp: ${date} | Nonce: <strong>${block.nonce}</strong>
                    </p>
                    <p style="font-size: 0.8em; margin: 5px 0;">
                        Hash: <code title="${block.hash}">${block.hash.substring(0, 15)}...</code> 
                    </p>
                    <details>
                        <summary style="color: var(--color-primary-accent); font-weight: 500; cursor: pointer;">Transactions (${block.transactions.length})</summary>
                        <ul style="list-style: none; padding-left: 0; margin-top: 10px;">${txList}</ul>
                    </details>
                </div>
            `;
            output.innerHTML += blockHtml;
        });
    }

    // --- Chain Validation ---
    function checkChainValidity(chain) {
        // Implementation remains the same
        let isValid = true;
        const target = Array(MINING_DIFFICULTY + 1).join("0");
        
        for (let i = 1; i < chain.length; i++) {
            const currentBlock = chain[i];
            const previousBlock = chain[i - 1];

            const tempBlock = new Block(currentBlock.index, currentBlock.transactions, currentBlock.previousHash);
            tempBlock.nonce = currentBlock.nonce;
            const calculatedHash = tempBlock.calculateHash();

            // 1. Check current hash (PoW)
            if (currentBlock.hash !== calculatedHash || currentBlock.hash.substring(0, MINING_DIFFICULTY) !== target) {
                isValid = false;
                break;
            }
            // 2. Check previous hash link
            if (currentBlock.previousHash !== previousBlock.hash) {
                isValid = false;
                break;
            }
        }
        document.getElementById('chain-valid').textContent = isValid ? 'VALID' : 'INVALID (Chain Tampered)';
        document.getElementById('chain-valid').style.color = isValid ? 'var(--color-success)' : 'var(--color-danger)';
    }

</script>
</body>
</html>

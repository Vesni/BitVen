<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitVen System</title>
    <style>
        /* Base Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        header h1 {
            margin: 0;
            font-size: 2em;
        }

        /* Card and Grid Layout */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid-layout {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            border: none;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-admin {
            background-color: #e67e22;
            border: none;
        }

        .btn-admin:hover {
            background-color: #d35400;
        }

        .sign-in-btn {
            background-color: #e74c3c;
            border: none;
            width: auto;
            display: inline-block;
        }

        .sign-in-btn:hover {
            background-color: #c0392b;
        }

        /* Status and Directory */
        #auth-status, #wallet-balance, #admin-area {
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .admin-only {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ecf0f1;
        }

        .directory-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
            list-style: none;
        }

        .directory-list li {
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .directory-list li:last-child {
            border-bottom: none;
        }

        .user-id {
            font-size: 0.8em;
            color: #7f8c8d;
            word-break: break-all;
        }

        .user-name {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Transaction Log */
        #transaction-log-list {
            list-style: none;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        #transaction-log-list li {
            background-color: #ecf0f1;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 6px;
        }
        
        .tx-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .tx-details {
            margin-top: 5px;
        }

        .tx-type {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            margin-right: 10px;
            font-size: 0.8em;
        }

        .tx-payment { background-color: #3498db; color: white; }
        .tx-fee { background-color: #e67e22; color: white; }
        .tx-bonus { background-color: #27ae60; color: white; }

        .tx-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .tx-in { color: #27ae60; }
        .tx-out { color: #e74c3c; }

        /* Utility */
        .hidden { display: none; }
        .error { color: #e74c3c; font-weight: bold; margin-top: 10px; }
        .status-message { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .status-success { background-color: #e8f9e8; border: 1px solid #27ae60; color: #27ae60; }
        .status-error { background-color: #f9e8e8; border: 1px solid #e74c3c; color: #e74c3c; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>BitVen System</h1>
        </header>

        <div id="status-display" class="status-message hidden"></div>

        <div class="grid-layout">
            
            <!-- Main Content: Send BVN, Balance, Log -->
            <div>
                <!-- Wallet/Balance Card -->
                <div class="card">
                    <h2>Wallet Status</h2>
                    <p id="auth-status">Status: Not Authenticated</p>
                    <p id="wallet-balance">Balance: Loading...</p>
                    <div id="sign-in-prompt">
                        <button class="sign-in-btn btn" onclick="signInWithGoogle()">Sign In with Google</button>
                    </div>
                </div>

                <!-- Send BVN Card -->
                <div class="card" id="send-bvn-card" style="display: none;">
                    <h2>Send BitVen (BVN)</h2>
                    <form id="send-bvn-form">
                        <div class="form-group">
                            <label for="recipient-id">Recipient (Email or UID):</label>
                            <input type="text" id="recipient-id" required placeholder="user@example.com or user-UID">
                        </div>
                        <div class="form-group">
                            <label for="send-amount">Amount (BVN):</label>
                            <input type="number" id="send-amount" min="0.01" step="0.01" required placeholder="e.g., 10.00">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Send BVN</button>
                        </div>
                    </form>
                </div>

                <!-- Transaction Log Card -->
                <div class="card">
                    <h2>Transaction Log (Real-Time)</h2>
                    <ul id="transaction-log-list">
                        <!-- Transactions will be inserted here -->
                        <li style="text-align: center; color: #7f8c8d;">Awaiting authentication...</li>
                    </ul>
                </div>
            </div>

            <!-- Sidebar: Directory and Admin -->
            <div>
                <!-- User Directory Card -->
                <div class="card">
                    <h2>User Directory</h2>
                    <ul id="directory-list" class="directory-list">
                        <!-- User profiles will be inserted here -->
                        <li style="text-align: center; color: #7f8c8d;">Loading profiles...</li>
                    </ul>
                </div>

                <!-- Admin Issuance Card -->
                <div class="card hidden" id="admin-area">
                    <h2>Admin System Operations</h2>
                    <p>Only the Administrator can use this feature to issue new BVN into the system.</p>
                    <form id="issue-bvn-form" class="admin-only">
                        <div class="form-group">
                            <label for="issue-recipient-id">Recipient (UID):</label>
                            <input type="text" id="issue-recipient-id" required placeholder="User UID">
                        </div>
                        <div class="form-group">
                            <label for="issue-amount">Amount (BVN):</label>
                            <input type="number" id="issue-amount" min="1" step="1" required placeholder="e.g., 1000">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-admin">Issue New BVN (Bonus)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, runTransaction, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANDATORY ENVIRONMENT CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWSebqVunmSzmw168fDZE_ePqoJ-_jsig",
            authDomain: "bitven-6d42c.firebaseapp.com",
            projectId: "bitven-6d42c",
            storageBucket: "bitven-6d42c.firebasestorage.app",
            messagingSenderId: "511584242303",
            appId: "1:511584242303:web:bdfeac7801c4d17b254d4a"
        };
        const ADMIN_EMAIL = 'lanushomeappliances@gmail.com';
        const NETWORK_FEE = 0.01;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        let app, db, auth;
        let userId = null;
        let isAdminUser = false;
        let profiles = {}; // Stores UID -> {email, name} for quick lookups
        let isAuthReady = false;

        // --- DOM Elements ---
        const statusDisplay = document.getElementById('status-display');
        const authStatusEl = document.getElementById('auth-status');
        const balanceEl = document.getElementById('wallet-balance');
        const logListEl = document.getElementById('transaction-log-list');
        const directoryListEl = document.getElementById('directory-list');
        const adminAreaEl = document.getElementById('admin-area');
        const sendBvnCardEl = document.getElementById('send-bvn-card');
        const signInPromptEl = document.getElementById('sign-in-prompt');
        
        // --- Utility Functions ---
        const displayStatus = (message, isError = false) => {
            statusDisplay.textContent = message;
            statusDisplay.className = 'status-message';
            statusDisplay.classList.add(isError ? 'status-error' : 'status-success');
            statusDisplay.classList.remove('hidden');
            setTimeout(() => statusDisplay.classList.add('hidden'), 5000);
        };

        const generateReference = () => {
            return 'TX-' + new Date().getTime() + '-' + Math.random().toString(36).substring(2, 9).toUpperCase();
        };

        const formatBVN = (amount) => {
            if (isAdminUser && amount === Infinity) return '∞ BVN';
            return `${parseFloat(amount).toFixed(2)} BVN`;
        };

        // --- Core Business Logic ---

        const calculateAndDisplayBalance = (transactions) => {
            if (!isAuthReady) return;

            if (isAdminUser) {
                balanceEl.innerHTML = `Balance: <span style="color: #27ae60; font-weight: bold;">${formatBVN(Infinity)}</span>`;
                return;
            }

            let balance = 0;
            transactions.forEach(tx => {
                const amount = tx.amount;
                if (tx.sender === userId && tx.recipient !== 'NETWORK') {
                    // Outgoing P2P payment or Fee (Rule 1a/1b)
                    balance -= amount;
                } else if (tx.recipient === userId) {
                    // Incoming payment or Fee refund (If not a self-fee, the fee rule ensures sender is also user for fee)
                    balance += amount;
                }
            });

            const color = balance >= 0 ? '#27ae60' : '#e74c3c';
            balanceEl.innerHTML = `Balance: <span style="color: ${color}; font-weight: bold;">${formatBVN(balance)}</span>`;
        };

        const renderTransactionLog = (transactions) => {
            if (!isAuthReady) return;
            logListEl.innerHTML = '';
            
            if (transactions.length === 0) {
                logListEl.innerHTML = '<li style="text-align: center; color: #7f8c8d;">No transactions found.</li>';
                return;
            }

            // Sort by timestamp descending
            transactions.sort((a, b) => b.timestamp - a.timestamp);

            transactions.forEach(tx => {
                const isIncoming = tx.recipient === userId && tx.type !== 'fee';
                const isOutgoing = tx.sender === userId && tx.type !== 'bonus';
                const isFee = tx.type === 'fee';

                let amountText;
                let directionClass;
                let typeClass;
                let description;

                if (isFee) {
                    amountText = formatBVN(tx.amount);
                    directionClass = 'tx-out'; 
                    typeClass = 'tx-fee';
                    description = `System Fee`;
                } else if (isIncoming) {
                    amountText = `+${formatBVN(tx.amount)}`;
                    directionClass = 'tx-in';
                    typeClass = 'tx-payment';
                    description = `From: ${profiles[tx.sender]?.name || 'Unknown User'}`;
                } else if (isOutgoing) {
                    amountText = `-${formatBVN(tx.amount)}`;
                    directionClass = 'tx-out';
                    typeClass = 'tx-payment';
                    description = `To: ${profiles[tx.recipient]?.name || 'Unknown User'}`;
                } else if (tx.type === 'bonus' && tx.recipient === userId) {
                    amountText = `+${formatBVN(tx.amount)}`;
                    directionClass = 'tx-in';
                    typeClass = 'tx-bonus';
                    description = `Issued by Network Admin`;
                } else {
                    return; // Skip if not relevant to the user
                }

                const date = new Date(tx.timestamp).toLocaleString();
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="tx-header">
                        <span>${date}</span>
                        <span>Ref: ${tx.reference.substring(0, 10)}...</span>
                    </div>
                    <div class="tx-details">
                        <span class="tx-type ${typeClass}">${tx.type.toUpperCase()}</span>
                        <span class="tx-amount ${directionClass}">${amountText}</span>
                        <p style="margin: 5px 0 0;">${description}</p>
                    </div>
                `;
                logListEl.appendChild(li);
            });
        };

        const renderDirectory = (profilesData) => {
            directoryListEl.innerHTML = '';
            Object.values(profilesData).forEach(profile => {
                if (profile.uid !== userId) { // Don't list self
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="user-name">${profile.name}</div>
                        <div>
                            <div class="user-id">${profile.email}</div>
                            <div class="user-id">ID: ${profile.uid}</div>
                        </div>
                    `;
                    directoryListEl.appendChild(li);
                }
            });
            if (directoryListEl.innerHTML === '') {
                 directoryListEl.innerHTML = '<li style="text-align: center; color: #7f8c8d;">No other users in directory.</li>';
            }
        };

        // --- Firestore Operations ---

        const sendBitVen = async (recipientId, amount) => {
            const amountFloat = parseFloat(amount);
            if (amountFloat <= 0) {
                displayStatus('Amount must be positive.', true);
                return;
            }
            if (userId === recipientId) {
                displayStatus('Cannot send BVN to yourself (use the Issue feature for admin).', true);
                return;
            }
            if (!profiles[recipientId] && !profiles[Object.keys(profiles).find(key => profiles[key].email === recipientId)]) {
                displayStatus('Recipient ID or Email not found in directory.', true);
                return;
            }

            const sender = userId;
            const recipient = profiles[recipientId] ? recipientId : Object.keys(profiles).find(key => profiles[key].email === recipientId);
            if (!recipient) {
                displayStatus('Recipient ID not found. Ensure the UID or Email is correct.', true);
                return;
            }

            // Note: Balance check is done inside the transaction for atomic safety
            try {
                const transactionResult = await runTransaction(db, async (transaction) => {
                    // --- 1. Fee Transaction (Type: fee) ---
                    // Rule 1b: sender MUST be userId, recipient MUST be userId, type MUST be 'fee'.
                    const feeRef = doc(collection(db, `artifacts/${appId}/public/data/ledger_transactions_v3`));
                    const feeData = {
                        timestamp: Date.now(),
                        sender: sender,
                        recipient: sender, // Recipient is also the sender for the fee transaction
                        amount: NETWORK_FEE,
                        type: 'fee',
                        reference: generateReference()
                    };
                    transaction.set(feeRef, feeData);
                    
                    // --- 2. P2P Payment Transaction (Type: payment) ---
                    // Rule 1a: sender MUST be userId, recipient MUST NOT be userId, type MUST be 'payment'.
                    const paymentRef = doc(collection(db, `artifacts/${appId}/public/data/ledger_transactions_v3`));
                    const paymentData = {
                        timestamp: Date.now(),
                        sender: sender,
                        recipient: recipient,
                        amount: amountFloat,
                        type: 'payment',
                        reference: generateReference()
                    };
                    transaction.set(paymentRef, paymentData);

                    return true;
                });
                
                if (transactionResult) {
                    displayStatus(`Successfully sent ${formatBVN(amountFloat)} to ${profiles[recipient]?.name || recipient}. Network Fee: ${formatBVN(NETWORK_FEE)}.`);
                }
            } catch (e) {
                if (e.message.includes('insufficient permissions')) {
                    displayStatus('Transaction failed: Insufficient permissions (Check Security Rules and Sender/Recipient UIDs).', true);
                } else {
                    displayStatus(`Transaction failed: ${e.message}`, true);
                }
            }
        };


        const issueBitVen = async (recipientId, amount) => {
            if (!isAdminUser) {
                displayStatus('Access Denied: Only the Admin can issue BVN.', true);
                return;
            }
            const amountFloat = parseFloat(amount);
            if (amountFloat <= 0) {
                displayStatus('Amount must be positive.', true);
                return;
            }
            if (!profiles[recipientId]) {
                 displayStatus('Recipient ID not found in directory.', true);
                return;
            }

            // Rule 2: sender MUST be 'NETWORK', type MUST be 'bonus', and writer MUST be Admin.
            const txData = {
                timestamp: Date.now(),
                sender: 'NETWORK', 
                recipient: recipientId,
                amount: amountFloat,
                type: 'bonus',
                reference: generateReference()
            };

            try {
                const txCollection = collection(db, `artifacts/${appId}/public/data/ledger_transactions_v3`);
                await setDoc(doc(txCollection), txData);
                displayStatus(`Admin successfully issued ${formatBVN(amountFloat)} to ${profiles[recipientId]?.name || recipientId}.`);
            } catch (e) {
                console.error("Issue transaction failed:", e);
                displayStatus('Issue transaction failed: Missing or insufficient permissions.', true);
            }
        };
        
        // --- Authentication ---

        const handleAuthChange = async (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
                const userEmail = user.email || 'N/A';
                isAdminUser = userEmail === ADMIN_EMAIL;
                
                authStatusEl.innerHTML = `Status: <span style="color: #27ae60; font-weight: bold;">Authenticated</span> | Email: ${userEmail} | UID: ${userId}`;
                signInPromptEl.style.display = 'none';
                sendBvnCardEl.style.display = 'block';
                
                if (isAdminUser) {
                    adminAreaEl.classList.remove('hidden');
                } else {
                    adminAreaEl.classList.add('hidden');
                }

                // 1. Save/Update User Profile
                const profileRef = doc(db, `artifacts/${appId}/public/data/user_profiles_v2`, userId);
                await setDoc(profileRef, {
                    uid: userId,
                    email: userEmail,
                    name: user.displayName || userEmail,
                    admin: isAdminUser,
                    lastLogin: Date.now()
                }, { merge: true }).catch(e => {
                    console.error("Failed to save profile:", e);
                    displayStatus('Failed to save profile (Check Security Rules): Missing or insufficient permissions.', true);
                });

                // 2. Start Data Listeners
                startDataListeners();
            } else {
                userId = null;
                isAdminUser = false;
                authStatusEl.innerHTML = 'Status: Not Authenticated';
                balanceEl.textContent = 'Balance: N/A';
                adminAreaEl.classList.add('hidden');
                sendBvnCardEl.style.display = 'none';
                signInPromptEl.style.display = 'block';
                logListEl.innerHTML = '<li style="text-align: center; color: #7f8c8d;">Awaiting authentication...</li>';
                directoryListEl.innerHTML = '<li style="text-align: center; color: #7f8c8d;">Loading profiles...</li>';
            }
        };
        
        window.signInWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    displayStatus(`Sign-in failed: ${error.message}`, true);
                });
        };

        const startDataListeners = () => {
            if (!userId) return;

            // Listener 1: User Directory
            const profilesCollection = collection(db, `artifacts/${appId}/public/data/user_profiles_v2`);
            onSnapshot(profilesCollection, (snapshot) => {
                profiles = {};
                snapshot.forEach(d => {
                    profiles[d.id] = d.data();
                    profiles[d.data().email] = d.data(); // Allow lookup by email
                });
                renderDirectory(profiles);
                console.log("User profiles snapshot received.");
            });

            // Listener 2: Transaction Log (ALL transactions)
            const txCollection = collection(db, `artifacts/${appId}/public/data/ledger_transactions_v3`);
            onSnapshot(txCollection, (snapshot) => {
                const transactions = [];
                snapshot.forEach(d => transactions.push(d.data()));
                
                calculateAndDisplayBalance(transactions);
                renderTransactionLog(transactions);
                console.log("Transaction log snapshot received.");
            });
        };

        // --- Initialization ---

        const initializeBitVen = () => {
             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayStatus(`Fatal Error: Firebase initialization failed. Please check your config.`, true);
                return; 
            }
            
            console.log("Attempting authentication...");

            // Use the provided auth token if available, otherwise rely on Google sign-in
            if (typeof __initial_auth_token !== 'undefined') {
                signInWithCustomToken(auth, __initial_auth_token)
                    .catch((error) => {
                        console.error("Custom token sign-in failed:", error);
                        displayStatus("Custom sign-in failed. Please use Google Sign-in.", true);
                    });
            } else {
                console.log("No initial auth token provided. User must manually sign in via Google.");
            }
            
            // Set up main auth state listener
            onAuthStateChanged(auth, handleAuthChange);

            // Setup form listeners
            document.getElementById('send-bvn-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recipientEmailOrId = document.getElementById('recipient-id').value.trim();
                const amount = document.getElementById('send-amount').value.trim();
                sendBitVen(recipientEmailOrId, amount);
                e.target.reset();
            });

            document.getElementById('issue-bvn-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recipientId = document.getElementById('issue-recipient-id').value.trim();
                const amount = document.getElementById('issue-amount').value.trim();
                issueBitVen(recipientId, amount);
                e.target.reset();
            });
        };

        initializeBitVen();
    </script>
</body>
</html>
